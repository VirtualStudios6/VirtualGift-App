<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#06011c">
  <link rel="icon" type="image/png" href="images/logo-virtual-login.png">
  <title>Noticias Fortnite ‚Äî VirtualGift</title>
  <link rel="stylesheet" href="css/inicio.css">
  <script defer src="js/app-mode.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>
  <script>
    function withAppFlag(url) {
      const isAndroidApp = document.documentElement.classList.contains("android-app") || document.body.classList.contains("android-app");
      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;
      const parts = url.split('#');
      const base = parts[0];
      const hash = parts[1] ? ('#' + parts[1]) : '';
      const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
      return fixed + hash;
    }
  </script>
  <style>
    /* ===== HEADER ===== */
    .fn-header {
      display: flex; align-items: center; gap: 12px;
      padding: 16px 20px; position: sticky; top: 0; z-index: 100;
      background: rgba(2,5,21,0.95); backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .back-btn {
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(255,255,255,0.08); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: background 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.14); }
    .back-btn svg { width: 18px; height: 18px; fill: white; }
    .fn-header-info { flex: 1; }
    .fn-header-title { font-size: 18px; font-weight: 800; color: white; }
    .fn-header-sub { font-size: 12px; color: #9ca3af; margin-top: 1px; }
    .fn-live-dot {
      background: #ef4444; color: white; font-size: 10px; font-weight: 800;
      padding: 3px 8px; border-radius: 6px;
      display: flex; align-items: center; gap: 4px;
      animation: livePulse 2s infinite;
    }
    .fn-live-dot::before { content:''; width:5px; height:5px; border-radius:50%; background:white; animation: pulse 1.5s infinite; }
    @keyframes livePulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 6px rgba(239,68,68,0)} }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* ===== TABS ===== */
    .news-tabs {
      display: flex; gap: 0;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      position: sticky; top: 61px; z-index: 9;
    }
    .news-tab {
      flex: 1; padding: 12px 8px; text-align: center;
      font-size: 13px; font-weight: 700; color: #6b7280;
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s; user-select: none;
    }
    .news-tab.active { color: #00d4ff; border-bottom-color: #00d4ff; }
    .news-tab:hover:not(.active) { color: #9ca3af; }

    /* ===== HERO CARD (primera noticia) ===== */
    .hero-card {
      margin: 16px 16px 0;
      border-radius: 18px; overflow: hidden;
      position: relative; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      transition: transform 0.2s;
      aspect-ratio: 16/9;
      background: #1a1a2e;
    }
    .hero-card:active { transform: scale(0.98); }
    .hero-img {
      width: 100%; height: 100%;
      object-fit: cover; display: block;
    }
    .hero-gradient {
      position: absolute; bottom: 0; left: 0; right: 0;
      padding: 40px 16px 16px;
      background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.5) 60%, transparent 100%);
    }
    .hero-tag {
      display: inline-block; background: #00d4ff; color: #000;
      font-size: 10px; font-weight: 800; padding: 3px 8px;
      border-radius: 6px; margin-bottom: 8px; letter-spacing: 0.5px;
    }
    .hero-title {
      font-size: 20px; font-weight: 900; color: white;
      line-height: 1.2; margin-bottom: 6px;
    }
    .hero-body {
      font-size: 13px; color: rgba(255,255,255,0.75); line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }

    /* ===== NEWS LIST ===== */
    .news-list { padding: 12px 16px 24px; display: flex; flex-direction: column; gap: 10px; }

    .news-item {
      display: flex; gap: 12px; align-items: flex-start;
      background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07);
      border-radius: 14px; padding: 12px; cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }
    .news-item:hover { background: rgba(255,255,255,0.07); }
    .news-item:active { transform: scale(0.98); }

    .news-item-img {
      width: 90px; height: 70px; border-radius: 10px;
      object-fit: cover; flex-shrink: 0; background: #1a1a2e;
    }
    .news-item-content { flex: 1; min-width: 0; }
    .news-item-tag {
      font-size: 10px; font-weight: 700; color: #00d4ff;
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
    }
    .news-item-title {
      font-size: 14px; font-weight: 800; color: white;
      line-height: 1.3; margin-bottom: 4px;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .news-item-body {
      font-size: 12px; color: #6b7280; line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }

    /* ===== MOTD CARDS (Message of the Day) ===== */
    .motd-grid {
      padding: 12px 16px 24px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .motd-card {
      border-radius: 16px; overflow: hidden; position: relative;
      cursor: pointer; border: 1px solid rgba(255,255,255,0.08);
      transition: transform 0.2s;
    }
    .motd-card:active { transform: scale(0.98); }
    .motd-img { width: 100%; height: 180px; object-fit: cover; display: block; background: #1a1a2e; }
    .motd-info { padding: 14px 16px 16px; background: rgba(0,0,0,0.4); }
    .motd-title { font-size: 17px; font-weight: 900; color: white; line-height: 1.2; }
    .motd-body { font-size: 13px; color: #9ca3af; margin-top: 6px; line-height: 1.5; }

    /* ===== LOADING / EMPTY ===== */
    .fn-loading { text-align: center; padding: 60px 20px; color: #9ca3af; }
    .fn-spinner {
      width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.08);
      border-top-color: #00d4ff; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fn-empty { text-align: center; padding: 60px 20px; color: #6b7280; }
    .fn-empty-icon { font-size: 40px; margin-bottom: 12px; }

    /* ===== SKELETON ===== */
    .skeleton-hero {
      margin: 16px 16px 0; border-radius: 18px; height: 200px;
      background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
    }
    .skeleton-item {
      display: flex; gap: 12px; padding: 12px;
      background: rgba(255,255,255,0.03); border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .skeleton-img {
      width: 90px; height: 70px; border-radius: 10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite; flex-shrink: 0;
    }
    .skeleton-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .skeleton-line {
      height: 12px; border-radius: 6px;
      background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* ===== MODAL ===== */
    .news-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.25s ease;
    }
    .news-overlay.open { opacity: 1; pointer-events: all; }
    .news-modal {
      width: 100%; max-width: 500px;
      border-radius: 24px 24px 0 0; overflow: hidden;
      background: #0d0b22; transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
      max-height: 92vh; display: flex; flex-direction: column;
    }
    .news-overlay.open .news-modal { transform: translateY(0); }
    .modal-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin: 12px auto 0; flex-shrink: 0; }
    .modal-cover { width: 100%; max-height: 240px; object-fit: cover; display: block; flex-shrink: 0; background: #1a1a2e; }
    .modal-close-btn {
      position: absolute; top: 18px; right: 16px; z-index: 10;
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(0,0,0,0.7); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-close-btn svg { width: 16px; height: 16px; fill: white; }
    .modal-body { padding: 20px 20px 40px; overflow-y: auto; flex: 1; }
    .modal-tag-badge {
      display: inline-block; background: rgba(0,212,255,0.15);
      border: 1px solid rgba(0,212,255,0.3);
      color: #00d4ff; font-size: 11px; font-weight: 700;
      padding: 4px 10px; border-radius: 20px; margin-bottom: 10px;
    }
    .modal-news-title { font-size: 22px; font-weight: 900; color: white; line-height: 1.2; margin-bottom: 10px; }
    .modal-news-body { font-size: 14px; color: #c4c4d4; line-height: 1.6; }
    .modal-media-relative { position: relative; flex-shrink: 0; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="fn-header">
    <button class="back-btn" onclick="history.back()">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <div class="fn-header-info">
      <div class="fn-header-title">üì° Noticias Fortnite</div>
      <div class="fn-header-sub" id="newsSubtitle">Cargando...</div>
    </div>
    <div class="fn-live-dot">LIVE</div>
  </div>

  <!-- TABS -->
  <div class="news-tabs">
    <div class="news-tab active" onclick="switchTab('br', this)">üéÆ Battle Royale</div>
    <div class="news-tab" onclick="switchTab('stw', this)">üè∞ Save the World</div>
    <div class="news-tab" onclick="switchTab('creative', this)">üé® Creativo</div>
  </div>

  <!-- CONTENT -->
  <div id="newsContent">
    <!-- Skeleton -->
    <div class="skeleton-hero"></div>
    <div class="news-list">
      <div class="skeleton-item">
        <div class="skeleton-img"></div>
        <div class="skeleton-content">
          <div class="skeleton-line" style="width:40%"></div>
          <div class="skeleton-line" style="width:80%"></div>
          <div class="skeleton-line" style="width:60%"></div>
        </div>
      </div>
      <div class="skeleton-item">
        <div class="skeleton-img"></div>
        <div class="skeleton-content">
          <div class="skeleton-line" style="width:35%"></div>
          <div class="skeleton-line" style="width:75%"></div>
          <div class="skeleton-line" style="width:55%"></div>
        </div>
      </div>
      <div class="skeleton-item">
        <div class="skeleton-img"></div>
        <div class="skeleton-content">
          <div class="skeleton-line" style="width:45%"></div>
          <div class="skeleton-line" style="width:85%"></div>
          <div class="skeleton-line" style="width:50%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="news-overlay" id="newsOverlay" onclick="closeModal(event)">
    <div class="news-modal" id="newsModal">
      <div class="modal-handle"></div>
      <div class="modal-media-relative">
        <img id="modalCover" class="modal-cover" src="" alt="">
        <button class="modal-close-btn" onclick="closeModalDirect()">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    function escHtml(s) { return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

    const TABS = { br: 'br', stw: 'savetheworld', creative: 'creative' };
    let activeTab = 'br';
    let cachedData = {};

    async function loadNews(tab) {
      const content = document.getElementById('newsContent');

      // Skeleton
      content.innerHTML = `
        <div class="skeleton-hero"></div>
        <div class="news-list">
          ${Array(4).fill(`<div class="skeleton-item"><div class="skeleton-img"></div><div class="skeleton-content"><div class="skeleton-line" style="width:40%"></div><div class="skeleton-line" style="width:80%"></div><div class="skeleton-line" style="width:60%"></div></div></div>`).join('')}
        </div>`;

      try {
        // Usar cache si existe
        if (cachedData[tab]) { renderNews(cachedData[tab], tab); return; }

        const res = await fetch(`https://fortnite-api.com/v2/news/${TABS[tab]}?language=es`);
        if (!res.ok) throw new Error("API error " + res.status);
        const json = await res.json();
        cachedData[tab] = json?.data;
        renderNews(json?.data, tab);
      } catch(e) {
        content.innerHTML = `<div class="fn-empty"><div class="fn-empty-icon">üì°</div><p>Error cargando noticias. Intenta de nuevo.</p></div>`;
      }
    }

    function renderNews(data, tab) {
      const content = document.getElementById('newsContent');

      if (!data) {
        content.innerHTML = `<div class="fn-empty"><div class="fn-empty-icon">üì≠</div><p>No hay noticias disponibles</p></div>`;
        document.getElementById('newsSubtitle').textContent = 'Sin noticias';
        return;
      }

      // La API puede devolver motds o news seg√∫n el modo
      const motds = data?.motd?.entries || [];
      const news = data?.news?.messages || [];
      const allItems = [...motds, ...news];

      if (!allItems.length) {
        content.innerHTML = `<div class="fn-empty"><div class="fn-empty-icon">üì≠</div><p>No hay noticias disponibles</p></div>`;
        document.getElementById('newsSubtitle').textContent = 'Sin noticias';
        return;
      }

      document.getElementById('newsSubtitle').textContent = `${allItems.length} noticias`;

      const [first, ...rest] = allItems;
      let html = '';

      // Hero card con la primera noticia
      const heroImg = first?.image || first?.fullImage || "";
      const heroTitle = first?.title || first?.tabTitle || "";
      const heroBody = first?.body || "";
      const heroTag = first?.category || (tab === 'br' ? 'Battle Royale' : tab === 'stw' ? 'Save the World' : 'Creativo');

      html += `
        <div class="hero-card" onclick="openModal(0, '${tab}')">
          ${heroImg ? `<img class="hero-img" src="${escHtml(heroImg)}" alt="${escHtml(heroTitle)}" onerror="this.style.display='none'">` : ''}
          <div class="hero-gradient">
            <div class="hero-tag">${escHtml(heroTag)}</div>
            <div class="hero-title">${escHtml(heroTitle)}</div>
            ${heroBody ? `<div class="hero-body">${escHtml(heroBody)}</div>` : ''}
          </div>
        </div>`;

      // Resto como lista
      if (rest.length) {
        html += `<div class="news-list">`;
        rest.forEach((item, i) => {
          const img = item?.image || item?.fullImage || "";
          const title = item?.title || item?.tabTitle || "";
          const body = item?.body || "";
          const tag = item?.category || heroTag;
          html += `
            <div class="news-item" onclick="openModal(${i+1}, '${tab}')">
              ${img ? `<img class="news-item-img" src="${escHtml(img)}" alt="${escHtml(title)}" onerror="this.style.display='none'">` : `<div class="news-item-img"></div>`}
              <div class="news-item-content">
                <div class="news-item-tag">${escHtml(tag)}</div>
                <div class="news-item-title">${escHtml(title)}</div>
                ${body ? `<div class="news-item-body">${escHtml(body)}</div>` : ''}
              </div>
            </div>`;
        });
        html += `</div>`;
      }

      content.innerHTML = html;
    }

    function switchTab(tab, el) {
      activeTab = tab;
      document.querySelectorAll('.news-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      loadNews(tab);
    }

    // ===== MODAL =====
    function openModal(idx, tab) {
      const data = cachedData[tab];
      if (!data) return;

      const motds = data?.motd?.entries || [];
      const news = data?.news?.messages || [];
      const allItems = [...motds, ...news];
      const item = allItems[idx];
      if (!item) return;

      const img = item?.image || item?.fullImage || "";
      const title = item?.title || item?.tabTitle || "";
      const body = item?.body || "";
      const tag = item?.category || (tab === 'br' ? 'Battle Royale' : tab === 'stw' ? 'Save the World' : 'Creativo');

      const coverEl = document.getElementById('modalCover');
      coverEl.src = img;
      coverEl.alt = title;
      coverEl.style.display = img ? 'block' : 'none';

      document.getElementById('modalBody').innerHTML = `
        <div class="modal-tag-badge">${escHtml(tag)}</div>
        <div class="modal-news-title">${escHtml(title)}</div>
        ${body ? `<div class="modal-news-body">${escHtml(body)}</div>` : ''}`;

      document.getElementById('newsOverlay').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeModalDirect() {
      document.getElementById('newsOverlay').classList.remove('open');
      document.body.style.overflow = '';
    }
    function closeModal(e) { if (e.target === document.getElementById('newsOverlay')) closeModalDirect(); }

    // Swipe down para cerrar
    let touchStartY = 0;
    document.getElementById('newsModal').addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; });
    document.getElementById('newsModal').addEventListener('touchend', e => { if (e.changedTouches[0].clientY - touchStartY > 80) closeModalDirect(); });

    // ===== AUTH =====
    function waitForFirebase(cb, max=50) {
      let i=0;
      const t = setInterval(()=>{
        i++;
        if (typeof firebase!=='undefined' && typeof firebase.auth==='function') { clearInterval(t); cb(); }
        else if (i>=max) clearInterval(t);
      }, 100);
    }

    window.addEventListener('load', () => {
      waitForFirebase(() => {
        firebase.auth().onAuthStateChanged(user => {
          if (!user) window.location.href = withAppFlag('index.html');
          else loadNews('br');
        });
      });
    });
  </script>
</body>
</html>
