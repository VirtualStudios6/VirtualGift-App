<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>VirtualGift - Iniciar Sesión</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>
  <style>
    /* Estilos adicionales para el footer mejorado */
    footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    footer p {
      margin: 0 0 1rem 0;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .footer-links {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .footer-links a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .footer-links a:hover {
      color: #ffffff;
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .footer-links a:active {
      transform: translateY(0);
      background-color: rgba(255, 255, 255, 0.15);
    }

    /* Separador visual entre enlaces */
    .footer-links a:not(:last-child)::after {
      content: '•';
      position: absolute;
      right: -0.5rem;
      color: rgba(255, 255, 255, 0.4);
      font-weight: bold;
    }

    /* Responsive para móviles - mantener horizontal */
    @media (max-width: 480px) {
      .footer-links {
        gap: 0.5rem;
        justify-content: center;
      }

      .footer-links a {
        font-size: 0.8rem;
        padding: 0.5rem 0.5rem;
      }

      footer {
        margin-top: 1.5rem;
        padding-top: 1rem;
      }

      footer p {
        font-size: 0.8rem;
        margin-bottom: 0.75rem;
      }
    }

    /* Tablets */
    @media (min-width: 481px) and (max-width: 768px) {
      .footer-links {
        gap: 0.75rem;
      }
    }

    /* Loading spinner para Discord */
    .btn-loading {
      position: relative;
      color: transparent !important;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin: -8px 0 0 -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-right-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Estilos para formularios */
    .form {
      display: none;
    }
    
    .form.active {
      display: block;
    }
    
    .recovery-container {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e293b;
      padding: 2rem;
      border-radius: 10px;
      z-index: 100;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 400px;
    }
    
    .recovery-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 99;
    }
    
    .recovery-container.active {
      display: block;
    }
    
    .recovery-overlay.active {
      display: block;
    }
    
    .recovery-buttons {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
    }
    
    .recovery-buttons .btn {
      flex: 1;
    }
    
    .error-msg {
      color: #f87171;
      font-size: 0.8rem;
      display: block;
      margin-top: 0.25rem;
    }
    
    .password-strength {
      height: 4px;
      background: #334155;
      border-radius: 2px;
      margin-top: 0.5rem;
      overflow: hidden;
    }
    
    #password-strength-bar {
      height: 100%;
      width: 0%;
      transition: width 0.3s, background-color 0.3s;
    }
    
    .terms {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 1rem 0;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #334155;
      transition: .4s;
      border-radius: 20px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #3b82f6;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .notification.success {
      background-color: #10b981;
    }
    
    .notification.error {
      background-color: #ef4444;
    }
    
    .notification.info {
      background-color: #3b82f6;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-card">
      <!-- Logo -->
      <div class="logo">
        <img src="images/logo-virtual-login.png" alt="Logo de VirtualGift">
      </div>

      <!-- Bienvenida -->
      <h2 class="welcome">Bienvenido a <span>VirtualGift</span></h2>

      <!-- Login -->
      <form id="login-form" class="form active">
        <label for="login-email">Correo electrónico</label>
        <input type="email" id="login-email" placeholder="Ingresa tu correo" required>

        <label for="login-password">Contraseña</label>
        <input type="password" id="login-password" placeholder="********" required>

        <a href="#" id="forgot-password" class="forgot">¿Olvidaste tu contraseña?</a>

        <button type="button" id="login-btn" class="btn gradient">Iniciar Sesión</button>

        <p class="switch-form">¿No tienes cuenta? 
          <a href="#" id="show-register">Regístrate</a>
        </p>
      </form>

      <!-- Recovery Overlay -->
      <div id="recovery-overlay" class="recovery-overlay"></div>

      <!-- Recuperación de contraseña -->
      <div id="recovery-container" class="recovery-container">
        <h3>Recuperar contraseña</h3>
        <p>Ingresa tu correo y te enviaremos un enlace para restablecerla.</p>
        <input type="email" id="recovery-email" placeholder="Tu correo">
        <div class="recovery-buttons">
          <button id="send-recovery-email" class="btn gradient">Enviar</button>
          <button id="cancel-recovery" class="btn social">Cancelar</button>
        </div>
      </div>

      <!-- Registro -->
      <form id="register-form" class="form">
        <label for="username">Nombre de usuario</label>
        <input type="text" id="username" placeholder="Elige un nombre de usuario" required>
        <span id="username-error" class="error-msg"></span>

        <label for="email">Correo electrónico</label>
        <input type="email" id="email" placeholder="tucorreo@ejemplo.com" required>
        <span id="email-error" class="error-msg"></span>

        <label for="password">Contraseña</label>
        <input type="password" id="password" placeholder="********" required>
        <span id="password-error" class="error-msg"></span>
        <div class="password-strength">
          <div id="password-strength-bar"></div>
        </div>

        <label for="confirm-password">Confirmar contraseña</label>
        <input type="password" id="confirm-password" placeholder="********" required>
        <span id="confirm-password-error" class="error-msg"></span>

        <!-- Términos con interruptor compacto -->
        <div class="terms">
          <label class="toggle-switch small">
            <input type="checkbox" id="terms">
            <span class="toggle-slider"></span>
          </label>
          <label for="terms">Acepto los Términos y Condiciones</label>
        </div>
        <span id="terms-error" class="error-msg"></span>

        <button type="button" id="register-btn" class="btn gradient">Registrarse</button>

        <p class="switch-form">¿Ya tienes una cuenta? 
          <a href="#" id="show-login">Inicia Sesión</a>
        </p>
      </form>

      <!-- Separador -->
      <div class="divider"><span>o</span></div>

      <!-- Login social -->
      <div class="social-login">
        <button id="discord-login" class="btn social">
          <svg class="social-icon" viewBox="0 0 24 24" fill="#5865F2">
            <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0002 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9554 2.4189-2.1568 2.4189Z"/>
          </svg>
          Continuar con Discord
        </button>
      </div>

      <!-- Pie de página actualizado -->
      <footer>
        <p>© 2026 VIRTUALGIFT</p>
        <div class="footer-links">
          <a href="terminos.html">Términos</a>
          <a href="../politica.html">Privacidad</a> <!-- Corregido el enlace -->
          <a href="pautas.html">Normas</a>
        </div>
      </footer>
    </div>
  </div>

  <!-- Notificación -->
  <div id="notification" class="notification"></div>

  <script>
    // ==================== CONFIGURACIÓN ====================
    const CONFIG = {
      NOTIFICATION_DURATION: 3500,
      PASSWORD_MIN_LENGTH: 8,
      INITIAL_USER_POINTS: 100,
      INITIAL_USER_LEVEL: 1,
      INITIAL_USER_EXPERIENCE: 0,
      NEXT_LEVEL_THRESHOLD: 200,
      DISCORD_CLIENT_ID: '1417729368825794640',
      DISCORD_REDIRECT_URI: 'https://virtualstudios6.github.io/VirtualGift-App/',
      // REEMPLAZA ESTO CON TU CLIENT_SECRET REAL:
      DISCORD_CLIENT_SECRET: 'FUabzEkiOoLogmzhUL6fXMVbaHN6nmUn'
    };

    // ==================== ESTADO GLOBAL ====================
    const State = {
      isLoading: false,
      setLoading(loading) {
        this.isLoading = loading;
        const buttons = ['login-btn', 'register-btn', 'send-recovery-email', 'discord-login'];
        buttons.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.disabled = loading;
            if (loading && btnId === 'discord-login') {
              btn.classList.add('btn-loading');
            } else {
              btn.classList.remove('btn-loading');
            }
          }
        });
      }
    };

    // ==================== NOTIFICACIONES ====================
    const NotificationManager = {
      show(message, type = 'success') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = `notification show ${type}`;
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, CONFIG.NOTIFICATION_DURATION);
      }
    };

    // ==================== MANEJO DE FORMULARIOS ====================
    const FormManager = {
      init() {
        // Mostrar formulario de login por defecto
        this.showForm('login-form');
        
        // Event listeners para cambiar entre formularios
        document.getElementById('show-register').addEventListener('click', (e) => {
          e.preventDefault();
          this.showForm('register-form');
        });
        
        document.getElementById('show-login').addEventListener('click', (e) => {
          e.preventDefault();
          this.showForm('login-form');
        });
        
        // Event listener para recuperar contraseña
        document.getElementById('forgot-password').addEventListener('click', (e) => {
          e.preventDefault();
          this.showRecoveryForm();
        });
        
        // Event listener para cancelar recuperación
        document.getElementById('cancel-recovery').addEventListener('click', (e) => {
          e.preventDefault();
          this.hideRecoveryForm();
        });
        
        // Event listener para overlay de recuperación
        document.getElementById('recovery-overlay').addEventListener('click', () => {
          this.hideRecoveryForm();
        });
        
        // Event listener para enviar correo de recuperación
        document.getElementById('send-recovery-email').addEventListener('click', () => {
          this.sendRecoveryEmail();
        });
        
        // Event listeners para los botones de login y registro
        document.getElementById('login-btn').addEventListener('click', () => {
          this.handleLogin();
        });
        
        document.getElementById('register-btn').addEventListener('click', () => {
          this.handleRegistration();
        });
        
        // Validación de contraseña en tiempo real
        document.getElementById('password').addEventListener('input', (e) => {
          this.checkPasswordStrength(e.target.value);
        });
      },
      
      showForm(formId) {
        // Ocultar todos los formularios
        document.querySelectorAll('.form').forEach(form => {
          form.classList.remove('active');
        });
        
        // Mostrar el formulario seleccionado
        document.getElementById(formId).classList.add('active');
        
        // Ocultar formulario de recuperación si está visible
        this.hideRecoveryForm();
      },
      
      showRecoveryForm() {
        document.getElementById('recovery-container').classList.add('active');
        document.getElementById('recovery-overlay').classList.add('active');
      },
      
      hideRecoveryForm() {
        document.getElementById('recovery-container').classList.remove('active');
        document.getElementById('recovery-overlay').classList.remove('active');
        document.getElementById('recovery-email').value = '';
      },
      
      async sendRecoveryEmail() {
        const email = document.getElementById('recovery-email').value.trim();
        
        if (!email) {
          NotificationManager.show('Por favor, ingresa tu correo electrónico', 'error');
          return;
        }
        
        if (!this.isValidEmail(email)) {
          NotificationManager.show('Por favor, ingresa un correo válido', 'error');
          return;
        }
        
        State.setLoading(true);
        
        try {
          await firebase.auth().sendPasswordResetEmail(email);
          NotificationManager.show('Se ha enviado un enlace de recuperación a tu correo', 'success');
          this.hideRecoveryForm();
        } catch (error) {
          console.error('Error al enviar correo de recuperación:', error);
          NotificationManager.show('Error al enviar el correo: ' + error.message, 'error');
        }
        
        State.setLoading(false);
      },
      
      async handleLogin() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
          NotificationManager.show('Por favor, completa todos los campos', 'error');
          return;
        }
        
        if (!this.isValidEmail(email)) {
          NotificationManager.show('Por favor, ingresa un correo válido', 'error');
          return;
        }
        
        State.setLoading(true);
        
        try {
          await firebase.auth().signInWithEmailAndPassword(email, password);
          NotificationManager.show('¡Inicio de sesión exitoso!', 'success');
          
          // Redirigir al dashboard después de un breve delay
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1500);
          
        } catch (error) {
          console.error('Error al iniciar sesión:', error);
          
          let errorMessage = 'Error al iniciar sesión';
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'No existe una cuenta con este correo';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Contraseña incorrecta';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Correo electrónico inválido';
          }
          
          NotificationManager.show(errorMessage, 'error');
        }
        
        State.setLoading(false);
      },
      
      async handleRegistration() {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const termsAccepted = document.getElementById('terms').checked;
        
        // Validaciones
        if (!username || !email || !password || !confirmPassword) {
          NotificationManager.show('Por favor, completa todos los campos', 'error');
          return;
        }
        
        if (!this.isValidEmail(email)) {
          NotificationManager.show('Por favor, ingresa un correo válido', 'error');
          return;
        }
        
        if (password.length < CONFIG.PASSWORD_MIN_LENGTH) {
          NotificationManager.show(`La contraseña debe tener al menos ${CONFIG.PASSWORD_MIN_LENGTH} caracteres`, 'error');
          return;
        }
        
        if (password !== confirmPassword) {
          NotificationManager.show('Las contraseñas no coinciden', 'error');
          return;
        }
        
        if (!termsAccepted) {
          NotificationManager.show('Debes aceptar los términos y condiciones', 'error');
          return;
        }
        
        State.setLoading(true);
        
        try {
          // Crear usuario en Firebase Auth
          const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Actualizar perfil con el nombre de usuario
          await user.updateProfile({
            displayName: username
          });
          
          // Guardar información adicional en Firestore
          await firebase.firestore().collection('users').doc(user.uid).set({
            username: username,
            email: email,
            points: CONFIG.INITIAL_USER_POINTS,
            level: CONFIG.INITIAL_USER_LEVEL,
            experience: CONFIG.INITIAL_USER_EXPERIENCE,
            nextLevel: CONFIG.NEXT_LEVEL_THRESHOLD,
            joinDate: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            emailVerified: false
          });
          
          // Enviar correo de verificación
          await user.sendEmailVerification();
          
          NotificationManager.show('¡Cuenta creada exitosamente! Se ha enviado un correo de verificación', 'success');
          
          // Redirigir al dashboard después de un breve delay
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2000);
          
        } catch (error) {
          console.error('Error al registrar usuario:', error);
          
          let errorMessage = 'Error al crear la cuenta';
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'Ya existe una cuenta con este correo';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = 'La contraseña es demasiado débil';
          }
          
          NotificationManager.show(errorMessage, 'error');
        }
        
        State.setLoading(false);
      },
      
      checkPasswordStrength(password) {
        const strengthBar = document.getElementById('password-strength-bar');
        let strength = 0;
        
        if (password.length >= CONFIG.PASSWORD_MIN_LENGTH) strength += 25;
        if (/[a-z]/.test(password)) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 25;
        
        strengthBar.style.width = strength + '%';
        
        if (strength < 50) {
          strengthBar.style.backgroundColor = '#ef4444'; // Rojo
        } else if (strength < 75) {
          strengthBar.style.backgroundColor = '#f59e0b'; // Amarillo
        } else {
          strengthBar.style.backgroundColor = '#10b981'; // Verde
        }
      },
      
      isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
    };

    // ==================== DISCORD OAUTH ====================
    const DiscordAuth = {
      async initiateLogin() {
        if (State.isLoading) return;
        State.setLoading(true);
        
        try {
          const state = this.generateState();
          sessionStorage.setItem('discord_oauth_state', state);
          
          const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${CONFIG.DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.DISCORD_REDIRECT_URI)}&response_type=code&scope=identify%20email&state=${state}&prompt=none`;
          
          window.location.href = authUrl;
        } catch (error) {
          NotificationManager.show('Error al conectar con Discord', 'error');
          State.setLoading(false);
        }
      },

      async handleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');

        if (error) {
          NotificationManager.show(`Error de Discord: ${error}`, 'error');
          this.cleanUrl();
          return;
        }

        if (code && state) {
          const savedState = sessionStorage.getItem('discord_oauth_state');
          if (state !== savedState) {
            NotificationManager.show('Error de seguridad', 'error');
            this.cleanUrl();
            return;
          }

          sessionStorage.removeItem('discord_oauth_state');
          await this.exchangeCodeForToken(code);
        }
      },

      async exchangeCodeForToken(code) {
        try {
          NotificationManager.show('Procesando autenticación...', 'info');
          
          // Intercambiar código por token usando client_secret
          const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              client_id: CONFIG.DISCORD_CLIENT_ID,
              client_secret: CONFIG.DISCORD_CLIENT_SECRET,
              grant_type: 'authorization_code',
              code: code,
              redirect_uri: CONFIG.DISCORD_REDIRECT_URI,
              scope: 'identify email'
            })
          });

          if (!tokenResponse.ok) {
            throw new Error('Error al obtener token de Discord');
          }

          const tokens = await tokenResponse.json();
          await this.getUserInfo(tokens.access_token);
          
        } catch (error) {
          console.error('Error Discord auth:', error);
          NotificationManager.show('Error en la autenticación', 'error');
          State.setLoading(false);
        }
      },

      async getUserInfo(accessToken) {
        try {
          const userResponse = await fetch('https://discord.com/api/users/@me', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });

          if (!userResponse.ok) {
            throw new Error('Error al obtener información del usuario');
          }

          const discordUser = await userResponse.json();
          await this.createFirebaseUser(discordUser);
          
        } catch (error) {
          NotificationManager.show('Error al obtener datos del usuario', 'error');
          State.setLoading(false);
        }
      },

      async createFirebaseUser(discordUser) {
        try {
          // Crear usuario en Firebase
          const email = `${discordUser.id}@discord.virtualgift.com`;
          const password = this.generateSecurePassword();
          
          const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Actualizar perfil
          await user.updateProfile({
            displayName: discordUser.username
          });
          
          // Guardar en Firestore
          await firebase.firestore().collection('users').doc(user.uid).set({
            username: discordUser.username,
            email: email,
            discordId: discordUser.id,
            discordUsername: discordUser.username,
            discordAvatar: discordUser.avatar,
            points: CONFIG.INITIAL_USER_POINTS,
            level: CONFIG.INITIAL_USER_LEVEL,
            experience: CONFIG.INITIAL_USER_EXPERIENCE,
            nextLevel: CONFIG.NEXT_LEVEL_THRESHOLD,
            joinDate: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            emailVerified: true,
            loginMethod: 'discord'
          });

          NotificationManager.show(`¡Bienvenido, ${discordUser.username}!`, 'success');
          this.cleanUrl();
          
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2000);
          
        } catch (error) {
          if (error.code === 'auth/email-already-in-use') {
            await this.handleExistingUser(discordUser);
          } else {
            NotificationManager.show('Error al crear usuario: ' + error.message, 'error');
            State.setLoading(false);
          }
        }
      },

      async handleExistingUser(discordUser) {
        try {
          const email = `${discordUser.id}@discord.virtualgift.com`;
          const password = this.generateSecurePassword();
          
          // Intentar login
          await firebase.auth().signInWithEmailAndPassword(email, password);
          NotificationManager.show(`¡Bienvenido de nuevo, ${discordUser.username}!`, 'success');
          
          this.cleanUrl();
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2000);
          
        } catch (error) {
          NotificationManager.show('Error al iniciar sesión', 'error');
          State.setLoading(false);
        }
      },

      generateState() {
        return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      },

      generateSecurePassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < 16; i++) {
          password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
      },

      cleanUrl() {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    };

    // ==================== INICIALIZACIÓN ====================
    document.addEventListener('DOMContentLoaded', function() {
      // Configuración inicial
      document.documentElement.style.backgroundColor = '#0f172a';
      document.body.style.backgroundColor = '#0f172a';
      
      // Inicializar el manejo de formularios
      FormManager.init();
      
      // Event listener para Discord
      const discordBtn = document.getElementById('discord-login');
      if (discordBtn) {
        discordBtn.addEventListener('click', () => DiscordAuth.initiateLogin());
      }

      // Manejar callback de Discord al cargar la página
      DiscordAuth.handleCallback();
    });
  </script>
</body>
</html>