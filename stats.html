<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#03010f">
  <link rel="icon" type="image/png" href="images/logo-virtual-login.png">
  <title>Stats Fortnite ‚Äî VirtualGift</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Barlow:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/inicio.css">
  <script defer src="js/app-mode.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>
  <script>
    function withAppFlag(url) {
      const isAndroidApp = document.documentElement.classList.contains("android-app") || document.body.classList.contains("android-app");
      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;
      const parts = url.split('#');
      const base = parts[0];
      const hash = parts[1] ? ('#' + parts[1]) : '';
      const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
      return fixed + hash;
    }
  </script>
  <style>
    :root {
      --bg: #03010f;
      --surface: #0a0818;
      --card: #0f0d1f;
      --border: rgba(255,255,255,0.07);
      --border-glow: rgba(99,102,241,0.35);
      --cyan: #00e5ff;
      --gold: #ffc837;
      --green: #00e676;
      --red: #ff4d6d;
      --purple: #a855f7;
      --text: #f1f0ff;
      --muted: #6b7280;
      --font-display: 'Rajdhani', sans-serif;
      --font-body: 'Barlow', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; }

    /* Grid noise bg */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0;
      background-image:
        linear-gradient(rgba(99,102,241,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99,102,241,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }
    #app { position: relative; z-index: 1; }

    /* ===== HEADER ===== */
    .stats-header {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 18px;
      background: rgba(3,1,15,0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
    }
    .back-btn {
      width: 34px; height: 34px; border-radius: 10px;
      background: rgba(255,255,255,0.06); border: 1px solid var(--border);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: all 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.1); }
    .back-btn svg { width: 17px; height: 17px; fill: white; }
    .header-title {
      font-family: var(--font-display); font-size: 22px; font-weight: 700;
      letter-spacing: 1px; color: white; flex: 1;
    }
    .header-title span { color: var(--cyan); }

    /* ===== SEARCH ===== */
    .search-wrap { padding: 18px 16px 0; }
    .search-box {
      display: flex; gap: 0; position: relative;
      background: var(--card); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px; overflow: hidden;
      transition: border-color 0.2s;
    }
    .search-box:focus-within {
      border-color: var(--cyan);
      box-shadow: 0 0 0 3px rgba(0,229,255,0.08);
    }
    .search-icon {
      width: 44px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .search-icon svg { width: 16px; height: 16px; fill: var(--muted); }
    .search-input {
      flex: 1; background: transparent; border: none; outline: none;
      color: white; font-size: 15px; font-family: var(--font-body);
      padding: 13px 0; font-weight: 600;
    }
    .search-input::placeholder { color: #374151; }
    .search-btn {
      background: var(--cyan); border: none;
      padding: 0 22px; color: #000; font-weight: 800; font-size: 13px;
      cursor: pointer; transition: all 0.2s;
      font-family: var(--font-display); font-size: 15px; letter-spacing: 1px;
      text-transform: uppercase;
    }
    .search-btn:hover { background: #33eaff; }
    .search-btn:active { transform: scale(0.97); }
    .search-btn:disabled { background: #1f2937; color: #374151; cursor: not-allowed; }

    /* ===== PLATFORM CHIPS ===== */
    .platform-wrap {
      display: flex; gap: 7px; padding: 12px 16px 0;
      overflow-x: auto; scrollbar-width: none;
    }
    .platform-wrap::-webkit-scrollbar { display: none; }
    .pchip {
      flex-shrink: 0; padding: 6px 14px; border-radius: 8px;
      font-size: 12px; font-weight: 700; font-family: var(--font-display);
      letter-spacing: 0.5px; cursor: pointer; user-select: none;
      background: rgba(255,255,255,0.04); border: 1px solid var(--border);
      color: var(--muted); transition: all 0.2s;
    }
    .pchip.active {
      background: rgba(0,229,255,0.12); border-color: rgba(0,229,255,0.4);
      color: var(--cyan);
    }

    /* ===== STATES ===== */
    .state-box { text-align: center; padding: 70px 24px; }
    .state-icon { font-size: 52px; margin-bottom: 16px; filter: grayscale(0.3); }
    .state-title { font-family: var(--font-display); font-size: 20px; font-weight: 700; color: #c4c4d4; margin-bottom: 8px; letter-spacing: 1px; }
    .state-sub { font-size: 13px; color: var(--muted); line-height: 1.6; max-width: 260px; margin: 0 auto; }
    .spinner {
      width: 44px; height: 44px; border: 3px solid rgba(255,255,255,0.06);
      border-top-color: var(--cyan); border-radius: 50%;
      animation: spin 0.7s linear infinite; margin: 0 auto 18px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== PROFILE BANNER ===== */
    .profile-banner {
      margin: 18px 16px 0; border-radius: 18px; overflow: hidden;
      background: linear-gradient(135deg, #0d0b20 0%, #160d2e 50%, #0a1628 100%);
      border: 1px solid rgba(99,102,241,0.25);
      position: relative;
    }
    .profile-banner::before {
      content: '';
      position: absolute; inset: 0; border-radius: 18px;
      background: linear-gradient(135deg, rgba(0,229,255,0.06) 0%, rgba(168,85,247,0.06) 100%);
    }
    .profile-inner {
      position: relative; padding: 20px;
      display: flex; align-items: center; gap: 16px;
    }
    .profile-avatar {
      width: 62px; height: 62px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(0,229,255,0.2), rgba(168,85,247,0.2));
      border: 2px solid rgba(0,229,255,0.3);
      display: flex; align-items: center; justify-content: center;
      font-size: 26px; flex-shrink: 0;
    }
    .profile-name {
      font-family: var(--font-display); font-size: 24px; font-weight: 700;
      color: white; letter-spacing: 0.5px; line-height: 1;
    }
    .profile-meta { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
    .profile-platform-badge {
      font-size: 10px; font-weight: 700; font-family: var(--font-display);
      padding: 3px 8px; border-radius: 5px; letter-spacing: 0.5px;
      background: rgba(0,229,255,0.15); color: var(--cyan); border: 1px solid rgba(0,229,255,0.2);
    }
    .profile-level-badge {
      font-size: 10px; font-weight: 700; font-family: var(--font-display);
      padding: 3px 8px; border-radius: 5px; letter-spacing: 0.5px;
      background: rgba(255,200,55,0.12); color: var(--gold); border: 1px solid rgba(255,200,55,0.2);
    }

    /* ===== KD + WINS HERO ===== */
    .hero-stats {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 10px; padding: 14px 16px 0;
    }
    .hero-stat {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px 12px; text-align: center;
      position: relative; overflow: hidden;
      transition: transform 0.2s, border-color 0.2s;
    }
    .hero-stat.wins { border-color: rgba(255,200,55,0.2); background: linear-gradient(180deg, rgba(255,200,55,0.07) 0%, var(--card) 100%); }
    .hero-stat.kd   { border-color: rgba(0,229,255,0.2);  background: linear-gradient(180deg, rgba(0,229,255,0.07) 0%, var(--card) 100%); }
    .hero-stat.wr   { border-color: rgba(0,230,118,0.2);  background: linear-gradient(180deg, rgba(0,230,118,0.07) 0%, var(--card) 100%); }
    .hero-val {
      font-family: var(--font-display); font-size: 28px; font-weight: 700;
      line-height: 1; letter-spacing: 0.5px;
    }
    .hero-val.gold   { color: var(--gold); }
    .hero-val.cyan   { color: var(--cyan); }
    .hero-val.green  { color: var(--green); }
    .hero-lbl {
      font-size: 10px; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: 1px; margin-top: 6px;
    }
    .hero-icon { font-size: 18px; margin-bottom: 6px; }

    /* ===== SECTION LABEL ===== */
    .sec-label {
      display: flex; align-items: center; gap: 8px;
      padding: 20px 16px 10px;
      font-family: var(--font-display); font-size: 13px; font-weight: 700;
      color: var(--muted); text-transform: uppercase; letter-spacing: 2px;
    }
    .sec-label::after { content:''; flex:1; height:1px; background: var(--border); }

    /* ===== MODE SELECTOR ===== */
    .mode-selector {
      display: flex; gap: 8px; padding: 0 16px;
    }
    .mode-btn {
      flex: 1; padding: 10px 6px; border-radius: 10px; text-align: center;
      font-family: var(--font-display); font-size: 14px; font-weight: 700;
      letter-spacing: 0.5px; cursor: pointer; user-select: none;
      background: rgba(255,255,255,0.04); border: 1px solid var(--border);
      color: var(--muted); transition: all 0.2s;
    }
    .mode-btn.active {
      background: rgba(0,229,255,0.12); border-color: rgba(0,229,255,0.35); color: var(--cyan);
    }
    .mode-btn .mode-icon { display: block; font-size: 16px; margin-bottom: 3px; }

    /* ===== STATS TABLE ===== */
    .stats-table {
      margin: 12px 16px 0;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden;
    }
    .stat-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      transition: background 0.15s;
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-row:hover { background: rgba(255,255,255,0.02); }
    .stat-row-left { display: flex; align-items: center; gap: 10px; }
    .stat-row-icon {
      width: 30px; height: 30px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; font-size: 14px;
      background: rgba(255,255,255,0.05); flex-shrink: 0;
    }
    .stat-row-name { font-size: 14px; font-weight: 600; color: #c4c4d4; }
    .stat-row-val {
      font-family: var(--font-display); font-size: 18px; font-weight: 700;
      letter-spacing: 0.5px;
    }
    .stat-row-val.gold  { color: var(--gold); }
    .stat-row-val.cyan  { color: var(--cyan); }
    .stat-row-val.green { color: var(--green); }
    .stat-row-val.red   { color: var(--red); }
    .stat-row-val.white { color: white; }

    /* Win rate bar */
    .wr-wrap { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .wr-bar-track { width: 80px; height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
    .wr-bar-fill { height: 100%; border-radius: 2px; background: var(--green); transition: width 0.8s ease; }

    /* ===== TOP PLAYS ===== */
    .top-plays { padding: 0 16px 100px; display: flex; flex-direction: column; gap: 8px; }
    .top-play {
      display: flex; align-items: center; gap: 12px;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 16px;
      transition: border-color 0.2s;
    }
    .top-play:nth-child(1) { border-color: rgba(255,200,55,0.2); }
    .top-play:nth-child(2) { border-color: rgba(156,163,175,0.15); }
    .top-play:nth-child(3) { border-color: rgba(180,120,60,0.15); }
    .tp-rank {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display); font-size: 16px; font-weight: 700;
      flex-shrink: 0;
    }
    .tp-rank.r1 { background: rgba(255,200,55,0.15); color: var(--gold); border: 1px solid rgba(255,200,55,0.3); }
    .tp-rank.r2 { background: rgba(156,163,175,0.1); color: #9ca3af; border: 1px solid rgba(156,163,175,0.2); }
    .tp-rank.r3 { background: rgba(180,120,60,0.1); color: #b47c3c; border: 1px solid rgba(180,120,60,0.2); }
    .tp-rank.rn { background: rgba(255,255,255,0.04); color: var(--muted); border: 1px solid var(--border); }
    .tp-info { flex: 1; }
    .tp-mode { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .tp-kills { font-family: var(--font-display); font-size: 22px; font-weight: 700; color: white; line-height: 1; }
    .tp-kills span { font-size: 12px; color: var(--muted); font-family: var(--font-body); font-weight: 600; }
    .tp-right { text-align: right; }
    .tp-placed { font-family: var(--font-display); font-size: 15px; font-weight: 700; }
    .tp-placed.win { color: var(--green); }
    .tp-placed.top { color: var(--gold); }
    .tp-placed.other { color: var(--muted); }
    .tp-matches { font-size: 11px; color: var(--muted); margin-top: 3px; }

    /* No data */
    .no-mode-data { padding: 30px 0; text-align: center; color: var(--muted); font-size: 14px; }

    /* Animations */
    .fade-up { animation: fadeUp 0.4s ease forwards; opacity: 0; }
    @keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    .stagger-1 { animation-delay: 0.05s; }
    .stagger-2 { animation-delay: 0.1s; }
    .stagger-3 { animation-delay: 0.15s; }
    .stagger-4 { animation-delay: 0.2s; }
    .stagger-5 { animation-delay: 0.25s; }
    .stagger-6 { animation-delay: 0.3s; }
  </style>
</head>
<body>
<div id="app">

  <div class="stats-header">
    <button class="back-btn" onclick="history.back()">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <div class="header-title">FORTNITE <span>STATS</span></div>
  </div>

  <!-- SEARCH -->
  <div class="search-wrap">
    <div class="search-box">
      <div class="search-icon">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"/></svg>
      </div>
      <input class="search-input" id="playerInput" type="text"
        placeholder="Nombre de jugador..."
        autocomplete="off" autocorrect="off" spellcheck="false"
        onkeydown="if(event.key==='Enter') searchPlayer()">
      <button class="search-btn" id="searchBtn" onclick="searchPlayer()">BUSCAR</button>
    </div>
  </div>

  <!-- PLATFORM -->
  <div class="platform-wrap">
    <div class="pchip active" onclick="setPlatform('all',this)">üåê Todas</div>
    <div class="pchip" onclick="setPlatform('epic',this)">üéÆ Epic</div>
    <div class="pchip" onclick="setPlatform('psn',this)">üéÆ PlayStation</div>
    <div class="pchip" onclick="setPlatform('xbl',this)">üéÆ Xbox</div>
  </div>

  <!-- DYNAMIC CONTENT -->
  <div id="statsContent">
    <div class="state-box">
      <div class="state-icon">üéØ</div>
      <div class="state-title">BUSCA UN JUGADOR</div>
      <div class="state-sub">Ingresa el nombre de usuario para ver estad√≠sticas detalladas</div>
    </div>
  </div>

</div>

<script>
  const API_KEY = "73ffb01e-97df-46f7-b5ee-4023c5c020f5";
  let selectedPlatform = "all";
  let globalData = null;

  function setPlatform(p, el) {
    selectedPlatform = p;
    document.querySelectorAll('.pchip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
  }

  function fmt(n) {
    if (n == null || isNaN(n) || n === 0) return "0";
    if (n >= 1000000) return (n/1000000).toFixed(1)+"M";
    if (n >= 10000) return (n/1000).toFixed(0)+"K";
    if (n >= 1000) return (n/1000).toFixed(1)+"K";
    return String(Math.round(n));
  }
  function fmtPct(n) {
    if (!n) return "0%";
    return (n * 100).toFixed(1)+"%";
  }
  function fmtRatio(n) {
    if (!n) return "0.00";
    return Number(n).toFixed(2);
  }
  function escHtml(s) {
    return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  async function searchPlayer() {
    const name = document.getElementById('playerInput').value.trim();
    if (!name) return;
    const btn = document.getElementById('searchBtn');
    btn.disabled = true; btn.textContent = '...';

    document.getElementById('statsContent').innerHTML = `
      <div class="state-box">
        <div class="spinner"></div>
        <div class="state-title">BUSCANDO...</div>
        <div class="state-sub">${escHtml(name)}</div>
      </div>`;

    try {
      const platform = selectedPlatform === 'all' ? '' : `&accountType=${selectedPlatform}`;
      const res = await fetch(
        `https://fortnite-api.com/v2/stats/br/v2?name=${encodeURIComponent(name)}${platform}&image=all`,
        { headers: { "Authorization": API_KEY } }
      );
      if (res.status === 404) { showError("JUGADOR NO ENCONTRADO", "Verifica el nombre y la plataforma."); return; }
      if (!res.ok) throw new Error(res.status);
      const json = await res.json();
      globalData = json?.data;
      if (!globalData) throw new Error("sin datos");
      renderStats(globalData, 'overall');
    } catch(e) {
      console.error(e);
      showError("ERROR AL BUSCAR", "No se pudo conectar. Intenta de nuevo.");
    } finally {
      btn.disabled = false; btn.textContent = 'BUSCAR';
    }
  }

  function showError(title, sub) {
    document.getElementById('statsContent').innerHTML = `
      <div class="state-box">
        <div class="state-icon">üòï</div>
        <div class="state-title">${escHtml(title)}</div>
        <div class="state-sub">${escHtml(sub)}</div>
      </div>`;
  }

  function renderStats(data, mode) {
    const account = data.account || {};
    const all = data.stats?.all || {};
    const s = all[mode] || {};
    const overall = all.overall || {};
    const level = data.battlePass?.level || null;

    const PLATFORM_LABELS = { epic:'Epic Games', psn:'PlayStation', xbl:'Xbox', gamepad:'Gamepad', keyboardMouse:'PC' };
    const platformLabel = PLATFORM_LABELS[account.name] || account.name || 'Fortnite';

    const winRate = overall.winRate || 0;
    const winBarWidth = Math.min(100, (winRate * 100)).toFixed(1);

    // Build top plays from all modes
    const topPlays = buildTopPlays(all);

    let html = `
      <!-- PROFILE -->
      <div class="profile-banner fade-up">
        <div class="profile-inner">
          <div class="profile-avatar">üéÆ</div>
          <div>
            <div class="profile-name">${escHtml(account.name || 'Jugador')}</div>
            <div class="profile-meta">
              <span class="profile-platform-badge">${escHtml(platformLabel)}</span>
              ${level ? `<span class="profile-level-badge">‚≠ê LVL ${level}</span>` : ''}
            </div>
          </div>
        </div>
      </div>

      <!-- HERO STATS -->
      <div class="hero-stats">
        <div class="hero-stat wins fade-up stagger-1">
          <div class="hero-icon">üèÜ</div>
          <div class="hero-val gold">${fmt(overall.wins)}</div>
          <div class="hero-lbl">Victorias</div>
        </div>
        <div class="hero-stat kd fade-up stagger-2">
          <div class="hero-icon">‚öîÔ∏è</div>
          <div class="hero-val cyan">${fmtRatio(overall.kd)}</div>
          <div class="hero-lbl">K/D Ratio</div>
        </div>
        <div class="hero-stat wr fade-up stagger-3">
          <div class="hero-icon">üìà</div>
          <div class="hero-val green">${fmtPct(overall.winRate)}</div>
          <div class="hero-lbl">Win Rate</div>
        </div>
      </div>

      <!-- MODE SELECTOR -->
      <div class="sec-label">Modo de juego</div>
      <div class="mode-selector">
        ${['overall','solo','duo','squad'].map(m => `
          <div class="mode-btn ${mode===m?'active':''}" onclick="renderStats(globalData,'${m}')">
            <span class="mode-icon">${{overall:'üåê',solo:'üßç',duo:'üë•',squad:'üëä'}[m]}</span>
            ${{overall:'Global',solo:'Solo',duo:'D√∫o',squad:'Squad'}[m]}
          </div>`).join('')}
      </div>

      <!-- STATS TABLE -->
      <div class="sec-label">Estad√≠sticas ${escHtml({overall:'Globales',solo:'Solo',duo:'D√∫o',squad:'Squad'}[mode]||'')}</div>
      ${renderTable(s, winBarWidth)}

      <!-- TOP PLAYS -->
      <div class="sec-label">Mejores Partidas</div>
      <div class="top-plays">
        ${topPlays.length ? topPlays.map((p,i) => renderTopPlay(p,i)).join('') : '<div class="no-mode-data">Sin datos disponibles</div>'}
      </div>`;

    document.getElementById('statsContent').innerHTML = html;
  }

  function renderTable(s, winBarWidth) {
    if (!s || !Object.keys(s).length) {
      return `<div class="stats-table"><div class="no-mode-data" style="padding:24px">Sin datos para este modo</div></div>`;
    }
    const rows = [
      { icon:'üèÜ', label:'Victorias',        val: fmt(s.wins),             cls:'gold'  },
      { icon:'üíÄ', label:'Kills',             val: fmt(s.kills),            cls:'white' },
      { icon:'üéÆ', label:'Partidas',          val: fmt(s.matches),          cls:'white' },
      { icon:'‚öîÔ∏è', label:'K/D Ratio',         val: fmtRatio(s.kd),          cls:'cyan'  },
      { icon:'üí•', label:'Kills / Partida',   val: fmtRatio(s.killsPerMatch),cls:'white'},
      { icon:'‚è±Ô∏è', label:'Minutos Jugados',   val: fmt(s.minutesPlayed),    cls:'white' },
      { icon:'ü•á', label:'Top 3',             val: fmt(s.top3),             cls:'gold'  },
      { icon:'üéØ', label:'Score',             val: fmt(s.score),            cls:'white' },
    ];

    const wrRow = `
      <div class="stat-row fade-up stagger-4">
        <div class="stat-row-left">
          <div class="stat-row-icon">üìà</div>
          <span class="stat-row-name">Win Rate</span>
        </div>
        <div class="wr-wrap">
          <span class="stat-row-val green">${fmtPct(s.winRate)}</span>
          <div class="wr-bar-track"><div class="wr-bar-fill" style="width:${winBarWidth}%"></div></div>
        </div>
      </div>`;

    return `<div class="stats-table">
      ${rows.map((r,i) => `
        <div class="stat-row fade-up stagger-${Math.min(i+1,6)}">
          <div class="stat-row-left">
            <div class="stat-row-icon">${r.icon}</div>
            <span class="stat-row-name">${r.label}</span>
          </div>
          <span class="stat-row-val ${r.cls}">${r.val}</span>
        </div>`).join('')}
      ${wrRow}
    </div>`;
  }

  function buildTopPlays(all) {
    const plays = [];
    for (const mode of ['solo','duo','squad','ltm']) {
      const s = all[mode];
      if (!s || !s.top1) continue;
      plays.push({ mode, wins: s.wins||0, kills: s.kills||0, matches: s.matches||0, kd: s.kd||0, killsPerMatch: s.killsPerMatch||0 });
    }
    return plays.sort((a,b) => b.kills - a.kills).slice(0,5);
  }

  function renderTopPlay(p, i) {
    const rankClass = ['r1','r2','r3','rn','rn'][i] || 'rn';
    const modeLabel = {solo:'Solo',duo:'D√∫o',squad:'Squad',ltm:'LTM'}[p.mode] || p.mode;
    const winClass = p.wins > 0 ? 'win' : (p.matches > 0 && (p.wins/p.matches) > 0.2 ? 'top' : 'other');
    return `
      <div class="top-play fade-up" style="animation-delay:${i*0.06}s">
        <div class="tp-rank ${rankClass}">${i+1}</div>
        <div class="tp-info">
          <div class="tp-mode">${modeLabel}</div>
          <div class="tp-kills">${fmt(p.kills)} <span>kills</span></div>
        </div>
        <div class="tp-right">
          <div class="tp-placed ${winClass}">${fmt(p.wins)} victorias</div>
          <div class="tp-matches">${fmt(p.matches)} partidas ¬∑ ${fmtRatio(p.kd)} K/D</div>
        </div>
      </div>`;
  }

  function waitForFirebase(cb, max=50) {
    let i=0;
    const t = setInterval(()=>{
      i++;
      if (typeof firebase!=='undefined' && typeof firebase.auth==='function') { clearInterval(t); cb(); }
      else if (i>=max) clearInterval(t);
    }, 100);
  }

  window.addEventListener('load', () => {
    waitForFirebase(() => {
      firebase.auth().onAuthStateChanged(user => {
        if (!user) window.location.href = withAppFlag('index.html');
      });
    });
  });
</script>
</body>
</html>
