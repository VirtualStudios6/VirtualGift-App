<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#06011c">
  <link rel="icon" type="image/png" href="images/logo-virtual-login.png">
  <title>Tienda Fortnite ‚Äî VirtualGift</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400;0,14..32,500;0,14..32,600;0,14..32,700;0,14..32,800;0,14..32,900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/inicio.css">
  <link rel="stylesheet" href="css/header.css">
  <script defer src="js/app-mode.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>
  <script>
    function withAppFlag(url) {
      const isAndroidApp = document.documentElement.classList.contains("android-app") || document.body.classList.contains("android-app");
      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;
      const parts = url.split('#');
      const base = parts[0];
      const hash = parts[1] ? ('#' + parts[1]) : '';
      const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
      return fixed + hash;
    }
  </script>
  <style>
    /* ===== TIENDA PAGE STYLES ===== */
    .tienda-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(2,5,21,0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .back-btn {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: background 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.14); }
    .back-btn svg { width: 18px; height: 18px; fill: white; }
    .tienda-header-info { flex: 1; }
    .tienda-title { font-size: 18px; font-weight: 800; color: white; }
    .tienda-subtitle { font-size: 12px; color: #9ca3af; margin-top: 1px; }
    .reset-badge {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      padding: 5px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 700; color: #ef4444;
      display: flex; align-items: center; gap: 5px; white-space: nowrap;
    }
    .reset-badge::before {
      content: ''; width: 6px; height: 6px;
      border-radius: 50%; background: #ef4444;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    .countdown-bar {
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding: 10px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .countdown-label { font-size: 12px; color: #9ca3af; }
    .countdown-timer {
      font-size: 15px; font-weight: 800; color: #00d4ff;
      font-variant-numeric: tabular-nums; letter-spacing: 1px;
    }

    .cat-tabs {
      display: flex; gap: 8px; padding: 14px 16px;
      overflow-x: auto; scrollbar-width: none;
      position: sticky; top: 61px; z-index: 9;
      background: rgba(6,1,28,0.95); backdrop-filter: blur(8px);
    }
    .cat-tabs::-webkit-scrollbar { display: none; }
    .cat-tab {
      flex-shrink: 0; padding: 7px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 700; cursor: pointer;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: #9ca3af; transition: all 0.2s; white-space: nowrap;
    }
    .cat-tab.active { background: #8d17fb; border-color: #8d17fb; color: white; }
    .cat-tab:hover:not(.active) { color: white; background: rgba(255,255,255,0.1); }

    .tienda-section { padding: 6px 16px 20px; }
    .tienda-section-title {
      font-size: 15px; font-weight: 800; color: white;
      margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
    }
    .tienda-count {
      font-size: 11px; font-weight: 600; color: #9ca3af;
      background: rgba(255,255,255,0.07); padding: 2px 8px; border-radius: 10px;
    }

    .shop-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
    }
    @media (min-width: 480px) { .shop-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; } }
    @media (min-width: 769px) { .shop-grid { grid-template-columns: repeat(6, 1fr); gap: 14px; } }

    .shop-item {
      border-radius: 12px; overflow: hidden; position: relative;
      cursor: pointer; border: 1px solid rgba(255,255,255,0.06);
      transition: transform 0.2s, box-shadow 0.2s;
      aspect-ratio: 0.75; display: flex; flex-direction: column;
    }
    .shop-item:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .shop-item:active { transform: scale(0.96); }
    .shop-item-img { flex: 1; width: 100%; object-fit: cover; object-position: top center; display: block; }
    .shop-item-info { padding: 6px 8px 7px; background: rgba(0,0,0,0.5); }
    .shop-item-name {
      font-size: 14px; font-weight: 700; color: white;
      line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .shop-item-price { display: flex; align-items: center; gap: 3px; margin-top: 3px; }
    .shop-item-price img { width: 16px; height: 16px; object-fit: contain; }
    .shop-item-price span { font-size: 13px; font-weight: 800; color: #7ec8e3; }

    .shop-item-play {
      position: absolute; top: 6px; right: 6px;
      width: 22px; height: 22px;
      background: rgba(0,0,0,0.6);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .shop-item-play svg { width: 12px; height: 12px; fill: white; margin-left: 1px; }

    .shop-loading {
      text-align: center; padding: 60px 20px; color: #9ca3af;
    }
    .shop-spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(255,255,255,0.08);
      border-top-color: #8d17fb; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .total-bar {
      padding: 12px 20px; text-align: center;
      font-size: 13px; color: #9ca3af;
      border-top: 1px solid rgba(255,255,255,0.05); margin-top: 10px;
    }
    .total-bar strong { color: white; }

    .preview-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .preview-overlay.open { opacity: 1; pointer-events: all; }
    .preview-modal {
      width: 100%; max-width: 480px;
      border-radius: 24px 24px 0 0; overflow: hidden;
      background: #0f0d2a;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-height: 90vh; display: flex; flex-direction: column;
    }
    .preview-overlay.open .preview-modal { transform: translateY(0); }
    .modal-handle {
      width: 40px; height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px; margin: 12px auto 0; flex-shrink: 0;
    }
    .preview-media { position: relative; background: #000; flex-shrink: 0; }
    .preview-media video, .preview-media img {
      width: 100%; max-height: 320px; object-fit: contain; display: block;
    }
    .preview-media-bg {
      position: absolute; inset: 0;
      filter: blur(20px) brightness(0.4); z-index: 0;
      background-size: cover; background-position: center;
    }
    .preview-media video, .preview-media img.preview-img {
      position: relative; z-index: 1;
    }
    .modal-close {
      position: absolute; top: 10px; right: 10px; z-index: 10;
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(0,0,0,0.6); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-close svg { width: 16px; height: 16px; fill: white; }
    .preview-info { padding: 16px 20px 32px; overflow-y: auto; }
    .preview-rarity-bar { height: 3px; border-radius: 2px; margin-bottom: 12px; }
    .preview-name { font-size: 22px; font-weight: 900; color: white; line-height: 1.2; }
    .preview-type {
      font-size: 12px; color: #9ca3af; margin-top: 4px;
      text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;
    }
    .preview-desc { font-size: 13px; color: #c4c4d4; margin-top: 10px; line-height: 1.5; }
    .preview-price-row {
      display: flex; align-items: center; gap: 8px;
      margin-top: 14px; padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.07);
    }
    .preview-price-row img { width: 20px; height: 20px; object-fit: contain; }
    .preview-price-row span { font-size: 22px; font-weight: 900; color: #7ec8e3; }
    .preview-price-label { font-size: 11px; color: #9ca3af; margin-left: auto; }
    .modal-video-loading {
      position: absolute; inset: 0; z-index: 5;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5);
    }
    .modal-video-loading .shop-spinner { margin: 0; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="tienda-header">
    <button class="back-btn" onclick="history.back()">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <div class="tienda-header-info">
      <div class="tienda-title">üõí Fortnite Shop</div>
      <div class="tienda-subtitle" id="itemCount">Cargando tienda...</div>
    </div>
    <div class="reset-badge">LIVE</div>
  </div>

  <!-- COUNTDOWN -->
  <div class="countdown-bar">
    <div class="countdown-label">üïê Tienda actual, Resetea en:</div>
    <div class="countdown-timer" id="countdown">--:--:--</div>
  </div>

  <!-- CATEGORY TABS -->
  <div class="cat-tabs" id="catTabs">
    <div class="cat-tab active" onclick="filterCategory('all', this)">üè™ Todo</div>
  </div>

  <!-- SHOP CONTENT -->
  <div id="shopContent">
    <div class="shop-loading">
      <div class="shop-spinner"></div>
      <p>Cargando tienda diaria...</p>
    </div>
  </div>

  <div class="total-bar" id="totalBar" style="display:none"></div>

  <!-- MODAL PREVIEW -->
  <div class="preview-overlay" id="previewOverlay" onclick="closePreview(event)">
    <div class="preview-modal" id="previewModal">
      <div class="modal-handle"></div>
      <div class="preview-media" id="previewMedia">
        <div class="preview-media-bg" id="previewBg"></div>
        <button class="modal-close" onclick="closeModal()">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
      <div class="preview-info" id="previewInfo"></div>
    </div>
  </div>

  <script>
    // ===== COUNTDOWN =====
    function updateCountdown() {
      const now = new Date();
      const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
      const rdNow = new Date(utcMs - 4 * 3600000);
      let reset = new Date(rdNow);
      reset.setHours(20, 0, 0, 0);
      if (rdNow >= reset) reset.setDate(reset.getDate() + 1);
      const diff = reset - rdNow;
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      document.getElementById('countdown').textContent =
        `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // ===== RARITY COLORS =====
    const RARITY_BG = {
      "poco com√∫n":"linear-gradient(160deg,#818181,#3a3a3a)","poco comun":"linear-gradient(160deg,#818181,#3a3a3a)",
      "com√∫n":"linear-gradient(160deg,#818181,#3a3a3a)","comun":"linear-gradient(160deg,#818181,#3a3a3a)","common":"linear-gradient(160deg,#818181,#3a3a3a)",
      "infrecuente":"linear-gradient(160deg,#60a32e,#2a4d10)","uncommon":"linear-gradient(160deg,#60a32e,#2a4d10)",
      "raro":"linear-gradient(160deg,#4f6fa8,#1f3a6a)","rare":"linear-gradient(160deg,#4f6fa8,#1f3a6a)",
      "√©pico":"linear-gradient(160deg,#8b38cc,#4a1575)","epico":"linear-gradient(160deg,#8b38cc,#4a1575)","epic":"linear-gradient(160deg,#8b38cc,#4a1575)",
      "legendario":"linear-gradient(160deg,#e8a224,#7a4d08)","legendary":"linear-gradient(160deg,#e8a224,#7a4d08)",
      "m√≠tico":"linear-gradient(160deg,#f0e13c,#7a6e0a)","mitico":"linear-gradient(160deg,#f0e13c,#7a6e0a)","mythic":"linear-gradient(160deg,#f0e13c,#7a6e0a)",
      "serie icon":"linear-gradient(160deg,#21c9c3,#0a5a57)","icon":"linear-gradient(160deg,#21c9c3,#0a5a57)",
      "serie marvel":"linear-gradient(160deg,#c1282d,#5a0a0d)","marvel":"linear-gradient(160deg,#c1282d,#5a0a0d)",
    };
    const RARITY_SOLID = {
      "poco com√∫n":"#818181","poco comun":"#818181","com√∫n":"#818181","comun":"#818181","common":"#818181",
      "infrecuente":"#60a32e","uncommon":"#60a32e","raro":"#4f6fa8","rare":"#4f6fa8",
      "√©pico":"#8b38cc","epico":"#8b38cc","epic":"#8b38cc","legendario":"#e8a224","legendary":"#e8a224",
      "m√≠tico":"#f0e13c","mitico":"#f0e13c","mythic":"#f0e13c","serie icon":"#21c9c3","icon":"#21c9c3",
      "serie marvel":"#c1282d","marvel":"#c1282d",
    };
    function getRarityBg(rarity) {
      const key = String(rarity||"").toLowerCase().trim();
      for (const [k,v] of Object.entries(RARITY_BG)) { if (key.includes(k)) return v; }
      return "linear-gradient(160deg,#1a1a2e,#0d0d1a)";
    }
    function getRaritySolid(rarity) {
      const key = String(rarity||"").toLowerCase().trim();
      for (const [k,v] of Object.entries(RARITY_SOLID)) { if (key.includes(k)) return v; }
      return "#8d17fb";
    }

    // ===== CATEGORY LABELS =====
    const CAT_LABELS = {
      "outfit":        { label: "üëï Skins", emoji: "üëï" },
      "emote":         { label: "üíÉ Emotes", emoji: "üíÉ" },
      "backpack":      { label: "üéí Mochilas", emoji: "üéí" },
      "pickaxe":       { label: "‚õèÔ∏è Picos", emoji: "‚õèÔ∏è" },
      "glider":        { label: "ü™Ç Planeadores", emoji: "ü™Ç" },
      "wrap":          { label: "üé® Wraps", emoji: "üé®" },
      "contrail":      { label: "‚ú® Estelas", emoji: "‚ú®" },
      "loading screen":{ label: "üñºÔ∏è Pantallas", emoji: "üñºÔ∏è" },
      "spray":         { label: "üñåÔ∏è Sprays", emoji: "üñåÔ∏è" },
      "toy":           { label: "ü™Ä Juguetes", emoji: "ü™Ä" },
      "music":         { label: "üéµ M√∫sica", emoji: "üéµ" },
      "banner":        { label: "üè≥Ô∏è Banners", emoji: "üè≥Ô∏è" },
      "other":         { label: "üì¶ Otros", emoji: "üì¶" },
    };
    function getCatKey(type) {
      const t = String(type||"").toLowerCase().trim();
      if (t.includes("outfit")) return "outfit";
      if (t.includes("emote")||t.includes("dance")) return "emote";
      if (t.includes("back")&&t.includes("pack")) return "backpack";
      if (t.includes("pickaxe")||t.includes("harvesting")) return "pickaxe";
      if (t.includes("glider")) return "glider";
      if (t.includes("wrap")) return "wrap";
      if (t.includes("contrail")) return "contrail";
      if (t.includes("loading")) return "loading screen";
      if (t.includes("spray")) return "spray";
      if (t.includes("toy")) return "toy";
      if (t.includes("music")) return "music";
      if (t.includes("banner")) return "banner";
      return "other";
    }

    const VBUCK = "https://fortnite-api.com/images/vbuck.png";
    let allItems = [], categorized = {}, activeFilter = "all";

    function showError() {
      document.getElementById('shopContent').innerHTML =
        `<div class="shop-loading"><p style="color:#ef4444">Error conectando con Firebase</p></div>`;
    }

    function buildCategoryTabs() {
      const tabs = document.getElementById('catTabs');
      tabs.innerHTML = `<div class="cat-tab active" onclick="filterCategory('all', this)">üè™ Todo</div>`;
      const order = ["outfit","emote","backpack","pickaxe","glider","wrap","contrail","spray","toy","music","loading screen","banner","other"];
      for (const key of order) {
        if (categorized[key]?.length > 0) {
          const info = CAT_LABELS[key] || { label: key, emoji: "üì¶" };
          const btn = document.createElement('div');
          btn.className = 'cat-tab';
          btn.textContent = `${info.emoji} ${info.label.split(' ')[1]||info.label} (${categorized[key].length})`;
          btn.onclick = function() { filterCategory(key, this); };
          tabs.appendChild(btn);
        }
      }
    }

    function filterCategory(key, el) {
      activeFilter = key;
      document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      renderShop();
    }

    function renderShop() {
      const content = document.getElementById('shopContent');
      const order = ["outfit","emote","backpack","pickaxe","glider","wrap","contrail","spray","toy","music","loading screen","banner","other"];
      if (activeFilter === 'all') {
        let html = '';
        for (const key of order) {
          if (!categorized[key]?.length) continue;
          const info = CAT_LABELS[key] || { label: key, emoji: "üì¶" };
          html += `<div class="tienda-section">
            <div class="tienda-section-title">${info.label}<span class="tienda-count">${categorized[key].length}</span></div>
            <div class="shop-grid">${categorized[key].map(item => renderItem(item)).join('')}</div>
          </div>`;
        }
        content.innerHTML = html || `<div class="shop-loading"><p>Tienda vac√≠a hoy</p></div>`;
      } else {
        const items = categorized[activeFilter] || [];
        const info = CAT_LABELS[activeFilter] || { label: activeFilter, emoji: "üì¶" };
        content.innerHTML = `<div class="tienda-section">
          <div class="tienda-section-title">${info.label}<span class="tienda-count">${items.length}</span></div>
          <div class="shop-grid">${items.map(item => renderItem(item)).join('')}</div>
        </div>`;
      }
      const totalBar = document.getElementById('totalBar');
      totalBar.style.display = 'block';
      totalBar.innerHTML = `<strong>${allItems.length}</strong> items en la tienda hoy`;
    }

    function renderItem(item) {
      const name = escapeHtml(item.name || "Item");
      const img = item.imageUrl || "";
      const price = item.price || 0;
      const bg = getRarityBg(item.rarity);
      const hasVideo = !!item.videoUrl;
      const idx = allItems.findIndex(i => i.id === item.id);
      return `<div class="shop-item" style="background:${bg}" onclick="openPreview(${idx})">
        ${img ? `<img class="shop-item-img" src="${escapeHtml(img)}" alt="${name}" loading="lazy" onerror="this.style.display='none'">` : `<div class="shop-item-img" style="flex:1"></div>`}
        ${hasVideo ? `<div class="shop-item-play"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>` : ''}
        <div class="shop-item-info">
          <div class="shop-item-name">${name}</div>
          ${price ? `<div class="shop-item-price"><img src="${VBUCK}" alt="V" onerror="this.style.display='none'"><span>${price}</span></div>` : ''}
        </div>
      </div>`;
    }

    function escapeHtml(str) {
      return String(str??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    async function openPreview(idx) {
      const item = allItems[idx];
      if (!item) return;
      const overlay = document.getElementById('previewOverlay');
      const mediaEl = document.getElementById('previewMedia');
      const bgEl = document.getElementById('previewBg');
      const infoEl = document.getElementById('previewInfo');
      const imgFull = item.imageFull || item.imageUrl || "";
      const solidColor = getRaritySolid(item.rarity);
      if (imgFull) bgEl.style.backgroundImage = `url('${imgFull}')`;
      mediaEl.querySelectorAll('video, img.preview-img').forEach(el => el.remove());
      const spinner = document.createElement('div');
      spinner.className = 'modal-video-loading';
      spinner.innerHTML = '<div class="shop-spinner"></div>';
      mediaEl.appendChild(spinner);
      infoEl.innerHTML = `
        <div class="preview-rarity-bar" style="background:${solidColor}"></div>
        <div class="preview-name">${escapeHtml(item.name || "Item")}</div>
        <div class="preview-type">${escapeHtml(item.rarity||"")} ¬∑ ${escapeHtml(item.type||"")}</div>
        ${item.description ? `<div class="preview-desc">${escapeHtml(item.description)}</div>` : ''}
        ${item.price ? `<div class="preview-price-row">
          <img src="${VBUCK}" alt="V" onerror="this.style.display='none'">
          <span>${item.price}</span>
          <span class="preview-price-label">V-Bucks</span>
        </div>` : ''}`;
      overlay.classList.add('open');
      document.body.style.overflow = 'hidden';
      let videoUrl = "";
      try {
        const res = await fetch(`https://fortnite-api.com/v2/cosmetics/br/${item.id}`);
        const data = await res.json();
        videoUrl = data?.data?.showcaseVideos?.[0] || "";
      } catch(e) { videoUrl = ""; }
      spinner.remove();
      if (videoUrl) {
        const video = document.createElement('video');
        video.src = videoUrl; video.autoplay = true; video.loop = true;
        video.muted = false; video.playsInline = true;
        video.style.cssText = 'width:100%;max-height:320px;object-fit:contain;display:block;position:relative;z-index:1;';
        video.onerror = () => {
          video.remove();
          const img = document.createElement('img');
          img.src = imgFull; img.className = 'preview-img';
          img.style.cssText = 'width:100%;max-height:320px;object-fit:contain;display:block;position:relative;z-index:1;';
          mediaEl.appendChild(img);
        };
        mediaEl.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = imgFull; img.className = 'preview-img';
        img.style.cssText = 'width:100%;max-height:320px;object-fit:contain;display:block;position:relative;z-index:1;';
        mediaEl.appendChild(img);
      }
    }

    function closeModal() {
      const overlay = document.getElementById('previewOverlay');
      overlay.classList.remove('open');
      document.body.style.overflow = '';
      const video = overlay.querySelector('video');
      if (video) { video.pause(); video.remove(); }
    }
    function closePreview(e) {
      if (e.target === document.getElementById('previewOverlay')) closeModal();
    }

    let touchStartY = 0;
    document.getElementById('previewModal').addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; });
    document.getElementById('previewModal').addEventListener('touchend', e => {
      if (e.changedTouches[0].clientY - touchStartY > 80) closeModal();
    });

    function loadShop() {
      window.db.collection("shopDailyItems").orderBy("sort","asc").onSnapshot(snap => {
        allItems = []; categorized = {};
        snap.forEach(doc => {
          const item = { id: doc.id, ...doc.data() };
          allItems.push(item);
          const key = getCatKey(item.type);
          if (!categorized[key]) categorized[key] = [];
          categorized[key].push(item);
        });
        document.getElementById('itemCount').textContent = `${allItems.length} items hoy`;
        buildCategoryTabs(); renderShop();
      }, err => { console.error(err); showError(); });
    }

    function waitForFirebase(cb, max=50) {
      let i=0;
      const t = setInterval(()=>{
        i++;
        if (typeof firebase!=='undefined' && typeof firebase.auth==='function' && window.db) { clearInterval(t); cb(); }
        else if (i>=max) { clearInterval(t); showError(); }
      }, 100);
    }

    window.addEventListener('load', () => {
      waitForFirebase(() => {
        firebase.auth().onAuthStateChanged(user => {
          if (!user) window.location.href = withAppFlag('index.html');
          else loadShop();
        });
      });
    });
  </script>
</body>
</html>
