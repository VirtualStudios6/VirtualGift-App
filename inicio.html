<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#06011c">

    <link rel="icon" type="image/png" href="images/logo-virtual-login.png">
    <title>VirtualGift</title>
    <link rel="stylesheet" href="css/inicio.css">

    <!-- ‚úÖ Android App Mode (marca html/body con class android-app si viene ?app=android) -->
    <script defer src="js/app-mode.js"></script>

    <!-- ‚úÖ NUEVO: Safe area mejorada en header -->
    <style>
        html.android-app .header,
        body.android-app .header {
            display: none !important;
        }

        /* ‚úÖ Safe area para notch en iPhone */
        .header {
            padding-top: calc(20px + env(safe-area-inset-top));
        }

        /* ‚úÖ NUEVO: Skeleton loader para noticias */
        .skeleton-news {
            animation: shimmer 1.5s infinite;
            background: linear-gradient(90deg,
                rgba(255,255,255,0.05) 25%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0.05) 75%
            );
            background-size: 200% 100%;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-news .news-image {
            background: rgba(255,255,255,0.1);
        }

        .skeleton-news .news-label {
            height: 14px;
            width: 80%;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin: 0 auto;
        }
    </style>

    <!-- Firebase -->
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script defer src="js/firebase-config.js"></script>

    <script>
        // ‚úÖ Helper: mantener app=android en navegaci√≥n interna
        function withAppFlag(url) {
            const isAndroidApp =
                document.documentElement.classList.contains("android-app") ||
                document.body.classList.contains("android-app");

            if (!isAndroidApp) return url;
            if (url.includes("app=android")) return url;

            const parts = url.split('#');
            const base = parts[0];
            const hash = parts[1] ? ('#' + parts[1]) : '';

            const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
            return fixed + hash;
        }
    </script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <img src="images/logo-virtual-login.png" alt="Virtual Studios Logo" class="logo-image">
            <span class="logo-text">VIRTUAL<span class="logo-studios">GIFT</span></span>
        </div>

        <div class="header-icons">
            <div class="icon-users" onclick="window.location.href=withAppFlag('home.html')" style="cursor: pointer;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
            </div>

            <div class="icon-coin" onclick="window.location.href=withAppFlag('puntos.html')" style="cursor: pointer;">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="48" fill="#FDB813"/>
                    <defs>
                        <radialGradient id="coinGradient">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FFA500;stop-opacity:1" />
                        </radialGradient>
                    </defs>
                    <circle cx="50" cy="50" r="42" fill="url(#coinGradient)"/>
                    <path d="M 30 30 L 42 65 L 50 65 L 58 65 L 70 30 L 62 30 L 54 57 L 50 57 L 46 57 L 38 30 Z" fill="#FFFACD"/>
                </svg>
            </div>

            <div class="icon-notification" onclick="window.location.href=withAppFlag('notificaciones.html')" style="cursor: pointer;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
                <span class="notification-badge" id="notificationBadge">0</span>
            </div>
        </div>
    </header>

    <!-- Gaming News Section -->
    <section class="section" id="news">
        <div class="section-header">
            <h2 class="section-title">Gaming News üì°</h2>
            <a href="#" class="section-link">Noticias</a>
        </div>

        <div class="news-grid" id="newsGrid">
            <!-- ‚úÖ NUEVO: Skeleton loader mientras carga -->
            <div class="news-card skeleton-news">
                <div class="news-image"></div>
                <p class="news-label"></p>
            </div>
            <div class="news-card skeleton-news">
                <div class="news-image"></div>
                <p class="news-label"></p>
            </div>
            <div class="news-card skeleton-news">
                <div class="news-image"></div>
                <p class="news-label"></p>
            </div>
        </div>

        <p id="newsError" style="display:none; color:#ef4444; margin-top:10px;">
            Error cargando noticias. Revisa la consola.
        </p>
    </section>

    <!-- Top Sorteos Section -->
    <section class="section" id="sorteos">
        <div class="section-header">
            <h2 class="section-title">Top Sorteos üèÜ</h2>
            <a href="#" class="section-link">Ver todo</a>
        </div>
        <div class="carousel-container">
            <div class="carousel-wrapper">
                <div class="carousel-slide">
                    <img src="images/banner-sorteos/1.png" alt="Sorteo 1">
                </div>
                <div class="carousel-slide">
                    <img src="images/banner-sorteos/2.png" alt="Sorteo 2">
                </div>
                <div class="carousel-slide">
                    <img src="images/banner-sorteos/3.png" alt="Sorteo 3">
                </div>
            </div>
            <div class="carousel-dots">
                <span class="carousel-dot active" data-index="0"></span>
                <span class="carousel-dot" data-index="1"></span>
                <span class="carousel-dot" data-index="2"></span>
            </div>
        </div>
    </section>

    <!-- Nuevas Skins Section -->
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Nuevas Skins üëï</h2>
            <span class="live-badge">LIVE</span>
        </div>
        <p class="section-subtitle">Fortnite</p>
        <div class="skins-grid">
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/1.png" alt="Skin 1">
                </div>
                <p class="skin-name">Skin Coni</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/2.png" alt="Skin 2">
                </div>
                <p class="skin-name">Skin Zeke</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/3.png" alt="Skin 3">
                </div>
                <p class="skin-name">Skin Grande Del Gr</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/4.png" alt="Skin 4">
                </div>
                <p class="skin-name">Skin Warrior</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/5.png" alt="Skin 5">
                </div>
                <p class="skin-name">Skin Phoenix</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/6.png" alt="Skin 6">
                </div>
                <p class="skin-name">Skin Shadow</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/7.png" alt="Skin 7">
                </div>
                <p class="skin-name">Skin Thunder</p>
            </div>
            <div class="skin-card">
                <div class="skin-badge">üîµ FORTNITE</div>
                <div class="skin-image">
                    <img src="images/skins-f/8.png" alt="Skin 8">
                </div>
                <p class="skin-name">Skin Galaxy</p>
            </div>
        </div>
    </section>

    <!-- Nuevos Emote Section -->
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Nuevos Emote üé≠</h2>
            <span class="live-badge">LIVE</span>
        </div>
        <p class="section-subtitle">Fortnite</p>
        <div class="emotes-grid">
            <div class="emote-card">
                <div class="emote-badge">üîµ FORTNITE</div>
                <div class="emote-image"></div>
                <p class="emote-name">Baile Batall√≥n De Origa...</p>
                <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ</div>
            </div>
            <div class="emote-card">
                <div class="emote-badge">üîµ FORTNITE</div>
                <div class="emote-image"></div>
                <p class="emote-name">Baile Sol Sofocante</p>
                <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            </div>
            <div class="emote-card">
                <div class="emote-badge">üîµ FORTNITE</div>
                <div class="emote-image"></div>
                <p class="emote-name">Baile GGUM</p>
                <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            </div>
        </div>
    </section>

    <!-- Popular Section -->
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">Popular</h2>
            <a href="#" class="section-link">Ver ahora</a>
        </div>
        <div class="popular-banner"></div>
    </section>

    <!-- Popular Games Section -->
    <section class="section" id="games">
        <div class="section-header">
            <h2 class="section-title">Popular Games</h2>
            <a href="#" class="section-link">Ver ahora</a>
        </div>
        <div class="games-grid">
            <div class="game-card">
                <div class="playing-badge">üî¥ PLAYING</div>
                <div class="game-image"></div>
                <p class="game-name">Color Challenge</p>
                <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            </div>
            <div class="game-card">
                <div class="playing-badge">üî¥ PLAYING</div>
                <div class="game-image"></div>
                <p class="game-name">Fill The Gap</p>
                <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            </div>
            <div class="game-card">
                <div class="playing-badge">üîµ PLAYING</div>
                <div class="game-image"></div>
                <p class="game-name">BOTTLE FLIP</p>
                <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            </div>
        </div>
    </section>

    <script src="js/carousel.js"></script>

    <!-- ‚úÖ OPTIMIZADO: Protecci√≥n de sesi√≥n y notificaciones eficientes -->
    <script>
        // ‚úÖ OPTIMIZACI√ìN 1: Cache para notificaciones
        const NOTIF_CACHE_KEY = 'vg_notif_count';
        const NOTIF_CACHE_DURATION = 2 * 60 * 1000; // 2 minutos

        function getCachedNotifCount() {
            try {
                const cached = localStorage.getItem(NOTIF_CACHE_KEY);
                if (!cached) return null;

                const data = JSON.parse(cached);
                const age = Date.now() - data.timestamp;

                if (age < NOTIF_CACHE_DURATION) {
                    console.log('‚úÖ Usando contador de notificaciones en cach√©');
                    return data.count;
                }

                localStorage.removeItem(NOTIF_CACHE_KEY);
                return null;
            } catch (e) {
                return null;
            }
        }

        function setCachedNotifCount(count) {
            try {
                localStorage.setItem(NOTIF_CACHE_KEY, JSON.stringify({
                    count: count,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.warn('Error al cachear notificaciones:', e);
            }
        }

        function isFirebaseReady() {
            return typeof firebase !== 'undefined'
                && typeof firebase.auth === 'function'
                && typeof firebase.firestore === 'function';
        }

        function waitForFirebase(callback, maxAttempts = 30) { // ‚úÖ Reducido de 60 a 30
            let attempts = 0;
            const check = setInterval(() => {
                attempts++;
                if (isFirebaseReady()) {
                    clearInterval(check);
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(check);
                    window.location.href = withAppFlag('index.html');
                }
            }, 100);
        }

        // ‚úÖ OPTIMIZACI√ìN 2: Cargar notificaciones SOLO UNA VEZ (no listener constante)
        async function loadNotificationCount(user) {
            if (!isFirebaseReady()) return;

            // Primero intentar cach√©
            const cachedCount = getCachedNotifCount();
            if (cachedCount !== null) {
                updateBadge(cachedCount);
                // Actualizar en segundo plano
                fetchNotificationCount(user);
                return;
            }

            // Si no hay cach√©, cargar de Firestore
            await fetchNotificationCount(user);
        }

        async function fetchNotificationCount(user) {
            try {
                const snapshot = await firebase.firestore()
                    .collection('notifications')
                    .where('userId', '==', user.uid)
                    .where('read', '==', false)
                    .get(); // ‚úÖ Llamada √∫nica, NO listener

                const count = snapshot.size;
                updateBadge(count);
                setCachedNotifCount(count);

                console.log('‚úÖ Notificaciones actualizadas:', count);
            } catch (err) {
                console.error("Error notificaciones:", err);
            }
        }

        function updateBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // ‚úÖ OPTIMIZACI√ìN 3: Refrescar al hacer click en notificaciones
        function setupNotificationRefresh(user) {
            const notifIcon = document.querySelector('.icon-notification');
            if (notifIcon) {
                notifIcon.addEventListener('click', () => {
                    // Limpiar cach√© para forzar actualizaci√≥n
                    localStorage.removeItem(NOTIF_CACHE_KEY);
                });
            }
        }

        function checkAuth() {
            waitForFirebase(() => {
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        window.location.href = withAppFlag('index.html');
                    } else {
                        loadNotificationCount(user);
                        setupNotificationRefresh(user);
                    }
                });
            });
        }

        window.addEventListener('load', checkAuth);
    </script>

    <!-- ‚úÖ Feed din√°mico de noticias (OBLIGATORIO) -->
    <script src="js/news-feed.js"></script>
</body>
</html>
