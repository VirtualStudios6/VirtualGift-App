<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#06011c">
  <title>Mi Perfil - VirtualGift</title>

  <!-- ‚úÖ Android App Mode -->
  <script defer src="js/app-mode.js"></script>

  <style>
    :root {
      --primary: #8d17fb;
      --secondary: #70189b;
      --bg-primary: #020515;
      --bg-secondary: #06011c;
      --card-bg: rgba(28, 31, 47, 0.92);
      --text-primary: #dcefff;
      --text-secondary: rgba(182, 198, 217, 0.9);
      --border: rgba(41, 50, 68, 0.75);
      --shadow: 0 10px 35px rgba(0,0,0,0.45);
      --danger: #ef4444;
      --success: #10b981;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Inter, Roboto, Arial, sans-serif; }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      padding: 18px;
      padding-bottom: 70px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .container { max-width: 900px; margin: 0 auto; }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 18px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 800;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .back-btn:active { transform: scale(0.98); }
    .back-btn:hover { border-color: rgba(141,23,251,.55); box-shadow: var(--shadow); }

    /* ‚úÖ Card de Perfil Moderna sin Banner */
    .profile-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 40px 20px;
      box-shadow: var(--shadow);
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }

    /* ‚úÖ Avatar con L√°piz para Editar */
    .avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid var(--primary);
      box-shadow: 0 0 30px rgba(141, 23, 251, 0.4);
      cursor: pointer;
      transition: all 0.2s ease;
      object-fit: cover;
      background: rgba(255,255,255,0.06);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .avatar:active { transform: scale(0.97); }

    /* ‚úÖ Bot√≥n L√°piz Flotante */
    .edit-avatar-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: 3px solid var(--bg-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(141, 23, 251, 0.4);
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .edit-avatar-btn:active { transform: scale(0.92); }
    .edit-avatar-btn:hover { transform: scale(1.05); }

    .edit-avatar-btn svg {
      width: 18px;
      height: 18px;
      fill: white;
    }

    /* Input oculto para foto */
    #avatarInput { display: none; }

    /* Usuario */
    .user-name {
      font-size: 2em;
      font-weight: 900;
      letter-spacing: 0.2px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #fff, #b8c6ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ‚úÖ Email Censurado con Ojito */
    .email-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .user-email {
      color: var(--text-secondary);
      font-size: 0.95em;
      opacity: 0.9;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.5px;
    }

    .toggle-email-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    .toggle-email-btn:active { transform: scale(0.95); }
    .toggle-email-btn:hover { background: rgba(255,255,255,0.08); }

    .toggle-email-btn svg {
      width: 18px;
      height: 18px;
      fill: var(--text-secondary);
    }

    /* Secciones */
    .section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.25);
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 1.1em;
      font-weight: 900;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: rgba(220,239,255,0.95);
    }

    /* Botones de Acci√≥n */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .btn {
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      cursor: pointer;
      font-weight: 900;
      font-size: 0.95em;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: rgba(2,5,21,0.35);
      color: var(--text-primary);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: scale(0.985); }

    .btn-primary {
      border: none;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 0 18px rgba(141, 23, 251, 0.25);
    }
    .btn-primary:hover { box-shadow: 0 0 24px rgba(141, 23, 251, 0.35); }

    .btn-secondary {
      background: rgba(28, 31, 47, 0.6);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #ffd5d5;
    }

    /* Loading & Error */
    .loading {
      text-align: center;
      padding: 40px 20px;
      min-height: 70vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
    }
    .error-icon {
      font-size: 4em;
      margin-bottom: 14px;
      opacity: 0.55;
    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(28,31,47,0.95);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px 14px;
      border-radius: 999px;
      color: var(--text-primary);
      box-shadow: var(--shadow);
      display: none;
      z-index: 9999;
      max-width: 92vw;
      text-align: center;
      font-weight: 800;
      font-size: 13px;
      backdrop-filter: blur(10px);
    }

    /* ‚úÖ Modal Cambiar Contrase√±a */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal.show { display: flex; }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.4em;
      font-weight: 900;
    }

    .close-modal {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 1.2em;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .close-modal:active { transform: scale(0.95); }

    .modal label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9em;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .modal input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(2,5,21,0.5);
      color: var(--text-primary);
      margin-bottom: 14px;
      font-size: 0.95em;
      outline: none;
    }
    .modal input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(141,23,251,0.1);
    }

    .modal .btn {
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      body { padding: 16px; padding-bottom: 76px; }
      .user-name { font-size: 1.7em; }
      .avatar { width: 110px; height: 110px; }
      .profile-card { padding: 35px 20px; }
    }
  </style>

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script defer src="js/firebase-config.js"></script>
</head>

<body>
  <!-- Loading -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>

  <!-- Error -->
  <div id="error" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <div class="error-message">No se pudo cargar tu perfil</div>
    <button class="btn btn-primary" onclick="location.reload()">Reintentar</button>
  </div>

  <!-- Contenido Principal -->
  <div id="content" class="container" style="display:none;">
    <div class="top-bar">
      <button class="back-btn" onclick="goBack()">‚Üê Volver</button>
    </div>

    <!-- ‚úÖ Card de Perfil Moderna -->
    <div class="profile-card">
      <!-- Avatar con L√°piz -->
      <div class="avatar-wrapper">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/120" alt="Avatar">
        <div class="edit-avatar-btn" onclick="openAvatarPicker()">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
        </div>
      </div>
      <input type="file" id="avatarInput" accept="image/*">

      <!-- Nombre -->
      <h1 class="user-name" id="userName">Usuario</h1>

      <!-- ‚úÖ Email Censurado con Ojito -->
      <div class="email-container">
        <p class="user-email" id="userEmail">correo@ejemplo.com</p>
        <button class="toggle-email-btn" onclick="toggleEmailVisibility()">
          <svg id="eyeIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- ‚úÖ Secci√≥n de Configuraci√≥n -->
    <div class="section">
      <h2 class="section-title">‚öôÔ∏è Configuraci√≥n</h2>
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="openChangePasswordModal()">
          üîë Cambiar Contrase√±a
        </button>
      </div>
    </div>

    <!-- ‚úÖ Secci√≥n de Sesi√≥n -->
    <div class="section">
      <h2 class="section-title">üö™ Sesi√≥n</h2>
      <div class="action-buttons">
        <button class="btn btn-danger" onclick="logout()">
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- ‚úÖ Modal Cambiar Contrase√±a -->
  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üîë Cambiar Contrase√±a</h2>
        <button class="close-modal" onclick="closeChangePasswordModal()">‚úï</button>
      </div>
      <label>Contrase√±a Actual</label>
      <input type="password" id="currentPassword" placeholder="Tu contrase√±a actual">

      <label>Nueva Contrase√±a</label>
      <input type="password" id="newPassword" placeholder="M√≠nimo 6 caracteres">

      <label>Confirmar Nueva Contrase√±a</label>
      <input type="password" id="confirmPassword" placeholder="Repite la nueva contrase√±a">

      <button class="btn btn-primary" id="changePasswordBtn" onclick="changePassword()">Actualizar Contrase√±a</button>
    </div>
  </div>

  <script>
    // ‚úÖ Inicializaci√≥n de Firebase
    function initializeFirebase() {
      if (typeof firebase !== 'undefined' && firebase.app) {
        if (!window.auth) window.auth = firebase.auth();
        if (!window.db) window.db = firebase.firestore();
        if (!window.storage) window.storage = firebase.storage();
      }
    }

    // ‚úÖ Mantener app=android en navegaci√≥n
    function withAppFlag(url) {
      const isAndroidApp =
        document.documentElement.classList.contains("android-app") ||
        document.body.classList.contains("android-app");

      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;

      const parts = url.split('#');
      const base = parts[0];
      const hash = parts[1] ? ('#' + parts[1]) : '';

      const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
      return fixed + hash;
    }

    function goBack() {
      window.location.href = withAppFlag('inicio.html');
    }

    const AVATAR_PLACEHOLDER = 'https://via.placeholder.com/120';
    const CACHE_KEY = 'vg_user_cache_profile';
    const CACHE_DURATION = 5 * 60 * 1000;

    let originalEmail = '';
    let isEmailVisible = false;

    const toast = (msg) => {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(() => el.style.display = 'none', 2600);
    };

    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
    }

    // ‚úÖ Censurar Email (versi√≥n m√°s segura)
    function censorEmail(email) {
      if (!email || !email.includes('@')) return email || 'correo@ejemplo.com';
      const [username, domain] = email.split('@');
      if (username.length <= 3) return email;

      const visibleStart = username.slice(0, 2);
      const visibleEnd = username.slice(-1);
      const censored = visibleStart + '*'.repeat(username.length - 3) + visibleEnd;
      return censored + '@' + domain;
    }

    // ‚úÖ Mostrar email parcial incluso cuando est√° "visible"
    function getPartialEmail(email) {
      if (!email || !email.includes('@')) return email;
      const [local, domain] = email.split('@');
      if (local.length <= 5) return email;

      const visiblePart = local.substring(0, 3) + '***' + local.substring(local.length - 2);
      return visiblePart + '@' + domain;
    }

    // ‚úÖ Toggle Visibilidad Email
    function toggleEmailVisibility() {
      isEmailVisible = !isEmailVisible;
      const emailEl = document.getElementById('userEmail');
      const eyeIcon = document.getElementById('eyeIcon');

      if (isEmailVisible) {
        // Mostrar email parcial (m√°s seguro que completo)
        emailEl.textContent = getPartialEmail(originalEmail);
        eyeIcon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
      } else {
        // Mostrar email censurado
        emailEl.textContent = censorEmail(originalEmail);
        eyeIcon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
      }
    }

    function safeSetAvatar(url) {
      const avatarEl = document.getElementById('avatar');
      const clean = (url && String(url).trim()) ? String(url).trim() : '';
      avatarEl.onerror = null;
      avatarEl.src = clean || AVATAR_PLACEHOLDER;
      avatarEl.onerror = () => {
        avatarEl.onerror = null;
        avatarEl.src = AVATAR_PLACEHOLDER;
      };
    }

    function getCachedUserData() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        const data = JSON.parse(cached);

        // Verificar que el usuario en cach√© sea el mismo que el actual
        const currentUser = window.auth?.currentUser;
        if (currentUser && data.userId !== currentUser.uid) {
          localStorage.removeItem(CACHE_KEY);
          return null;
        }

        const age = Date.now() - data.timestamp;
        if (age < CACHE_DURATION) return data.userData;

        localStorage.removeItem(CACHE_KEY);
        return null;
      } catch {
        return null;
      }
    }

    function setCachedUserData(userData, userId) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          userData,
          userId,
          timestamp: Date.now()
        }));
      } catch {}
    }

    function isFirebaseReady() {
      initializeFirebase();
      return typeof firebase !== 'undefined'
        && typeof firebase.auth === 'function'
        && typeof firebase.firestore === 'function'
        && typeof firebase.storage === 'function'
        && window.auth && window.db && window.storage;
    }

    function waitForFirebase(callback, maxAttempts = 30) {
      let attempts = 0;
      const check = setInterval(() => {
        attempts++;
        initializeFirebase();
        if (isFirebaseReady()) {
          clearInterval(check);
          callback();
        } else if (attempts >= maxAttempts) {
          clearInterval(check);
          console.error('Firebase timeout');
          showError();
        }
      }, 100);
    }

    function cacheBust(url) {
      const u = String(url || '').trim();
      if (!u) return u;
      const sep = u.includes('?') ? '&' : '?';
      return u + sep + 'v=' + Date.now();
    }

    function loadBasicUserData(user) {
      document.getElementById('userName').textContent = user.displayName || 'Usuario';

      // ‚úÖ Email censurado por defecto
      originalEmail = user.email || '';
      document.getElementById('userEmail').textContent = censorEmail(originalEmail);

      safeSetAvatar(cacheBust(user.photoURL) || AVATAR_PLACEHOLDER);
      showContent();
    }

    async function loadFirestoreData(user) {
      try {
        const cached = getCachedUserData();
        if (cached?.photoURL) {
          safeSetAvatar(cacheBust(cached.photoURL));
          fetchAndUpdateFirestore(user, true);
          return;
        }
        await fetchAndUpdateFirestore(user, false);
      } catch (e) {
        console.warn('Firestore load warning:', e);
      }
    }

    async function fetchAndUpdateFirestore(user, silent = false) {
      const ref = window.db.collection('users').doc(user.uid);
      const snap = await ref.get();
      if (!snap.exists) return;

      const data = snap.data() || {};
      setCachedUserData(data, user.uid);

      if (data.photoURL) {
        safeSetAvatar(cacheBust(data.photoURL));
      }
    }

    function checkAuth() {
      waitForFirebase(() => {
        window.auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = withAppFlag('index.html');
            return;
          }
          loadBasicUserData(user);
          await loadFirestoreData(user);
        });
      });
    }

    // ‚úÖ Abrir Selector de Avatar
    function openAvatarPicker() {
      const user = window.auth?.currentUser;
      if (!user) {
        toast('‚ùå No hay usuario autenticado');
        return;
      }
      const input = document.getElementById('avatarInput');
      input.value = '';
      input.click();
    }

    function loadImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Imagen inv√°lida')); };
        img.src = url;
      });
    }

    async function compressImageToJpeg(file, maxSize = 512, quality = 0.75) {
      const img = await loadImageFromFile(file);
      const width = img.naturalWidth || img.width;
      const height = img.naturalHeight || img.height;
      const scale = Math.min(maxSize / width, maxSize / height, 1);
      const newW = Math.max(1, Math.round(width * scale));
      const newH = Math.max(1, Math.round(height * scale));

      const canvas = document.createElement('canvas');
      canvas.width = newW;
      canvas.height = newH;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, newW, newH);

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), 'image/jpeg', quality);
      });

      if (!blob) throw new Error('No se pudo comprimir la imagen');
      return blob;
    }

    async function uploadAvatarBlob(user, blob) {
      const path = `avatars/${user.uid}.jpg`;
      const ref = window.storage.ref().child(path);
      const metadata = {
        contentType: 'image/jpeg',
        cacheControl: 'public, max-age=3600'
      };
      await ref.put(blob, metadata);
      return await ref.getDownloadURL();
    }

    async function setAvatarEverywhere(user, photoURL) {
      await user.updateProfile({ photoURL });
      await window.db.collection('users').doc(user.uid).set({
        photoURL,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      setCachedUserData({ photoURL }, user.uid);
    }

    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const user = window.auth?.currentUser;
      if (!user) return;

      try {
        const localUrl = URL.createObjectURL(file);
        safeSetAvatar(localUrl);
        setTimeout(() => URL.revokeObjectURL(localUrl), 5000);
      } catch {}

      try {
        toast('Subiendo avatar...');
        const blob = await compressImageToJpeg(file, 512, 0.75);
        const url = await uploadAvatarBlob(user, blob);
        await setAvatarEverywhere(user, url);
        safeSetAvatar(cacheBust(url));
        toast('‚úÖ Avatar actualizado');
      } catch (err) {
        console.error('Error subiendo avatar:', err);
        toast('‚ùå No se pudo subir el avatar');
        safeSetAvatar(cacheBust(user.photoURL) || AVATAR_PLACEHOLDER);
      }
    });

    // ‚úÖ Modal Cambiar Contrase√±a
    function openChangePasswordModal() {
      const user = window.auth?.currentUser;
      if (!user) {
        toast('‚ùå No hay usuario autenticado');
        return;
      }

      // Verificar que no sea un usuario temporal/an√≥nimo
      if (user.isAnonymous) {
        toast('‚ùå Los usuarios an√≥nimos no pueden cambiar contrase√±a');
        return;
      }

      // Verificar proveedor
      const provider = user.providerData?.[0]?.providerId;
      if (provider && provider !== 'password') {
        toast('‚ùå Solo para cuentas con email y contrase√±a');
        return;
      }

      document.getElementById('changePasswordModal').classList.add('show');
    }

    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.remove('show');
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    async function changePassword() {
      const user = window.auth?.currentUser;
      if (!user) {
        toast('‚ùå No hay usuario autenticado');
        return;
      }

      const currentPwd = document.getElementById('currentPassword').value;
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;

      if (!currentPwd || !newPwd || !confirmPwd) {
        toast('‚ùå Completa todos los campos');
        return;
      }

      if (newPwd.length < 6) {
        toast('‚ùå La nueva contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      if (newPwd !== confirmPwd) {
        toast('‚ùå Las contrase√±as no coinciden');
        return;
      }

      const submitBtn = document.getElementById('changePasswordBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Actualizando...';
      submitBtn.disabled = true;

      try {
        toast('Actualizando contrase√±a...');

        // Reautenticar usuario
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPwd);
        await user.reauthenticateWithCredential(credential);

        // Cambiar contrase√±a
        await user.updatePassword(newPwd);

        toast('‚úÖ Contrase√±a actualizada exitosamente');
        closeChangePasswordModal();
      } catch (error) {
        console.error('Error cambiando contrase√±a:', error);
        let message = '‚ùå Error al cambiar contrase√±a';

        switch(error.code) {
          case 'auth/wrong-password':
            message = '‚ùå Contrase√±a actual incorrecta';
            break;
          case 'auth/weak-password':
            message = '‚ùå La contrase√±a debe tener al menos 6 caracteres';
            break;
          case 'auth/requires-recent-login':
            message = '‚ùå Vuelve a iniciar sesi√≥n y prueba de nuevo';
            break;
          case 'auth/too-many-requests':
            message = '‚ùå Demasiados intentos. Espera unos minutos';
            break;
        }
        toast(message);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    function logout() {
      if (!confirm('¬øSeguro que quieres cerrar sesi√≥n?')) return;

      try { localStorage.removeItem(CACHE_KEY); } catch {}

      if (window.auth) {
        window.auth.signOut()
          .then(() => window.location.href = withAppFlag('index.html'))
          .catch(() => window.location.href = withAppFlag('index.html'));
      } else {
        window.location.href = withAppFlag('index.html');
      }
    }

    window.addEventListener('load', checkAuth);
  </script>
</body>
</html>
