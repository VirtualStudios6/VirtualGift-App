<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#06011c">
  <title>Mi Perfil - VirtualGift</title>

  <!-- ‚úÖ Android App Mode -->
  <script defer src="js/app-mode.js"></script>

  <style>
    :root {
      --primary: #8d17fb;
      --secondary: #70189b;

      --bg-primary: #020515;
      --bg-secondary: #06011c;

      --text-primary: #dcefff;
      --text-secondary: rgba(182, 198, 217, 0.9);

      --border: rgba(41, 50, 68, 0.75);
      --shadow: 0 10px 35px rgba(0,0,0,0.45);

      --danger: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Inter, Roboto, Arial, sans-serif; }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      padding: 18px;
      padding-bottom: 70px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    .container { max-width: 900px; margin: 0 auto; }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 18px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 800;
      transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .back-btn:active { transform: scale(0.98); }
    .back-btn:hover { border-color: rgba(141,23,251,.55); box-shadow: var(--shadow); }

    .profile-banner {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 22px;
      padding: 34px 22px 92px;
      position: relative;
      margin-bottom: 68px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* brillo suave */
    .profile-banner::after{
      content:"";
      position:absolute;
      inset:-60px -60px auto auto;
      width: 240px;
      height: 240px;
      background: rgba(255,255,255,0.12);
      filter: blur(40px);
      border-radius: 999px;
      transform: rotate(25deg);
      pointer-events:none;
    }

    .avatar-container {
      position: absolute;
      bottom: -58px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
    }

    .avatar {
      width: 118px;
      height: 118px;
      border-radius: 50%;
      border: 5px solid var(--bg-primary);
      box-shadow: 0 0 34px rgba(141, 23, 251, 0.55);
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      object-fit: cover;
      background: rgba(255,255,255,0.06);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .avatar:active { transform: scale(0.97); opacity: 0.95; }

    .avatar-hint {
      font-size: 12px;
      color: rgba(255,255,255,0.9);
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .profile-info {
      text-align: center;
      margin-top: 74px;
      margin-bottom: 18px;
    }

    .user-name {
      font-size: 1.85em;
      font-weight: 900;
      letter-spacing: 0.2px;
      margin-bottom: 6px;
    }

    .user-email {
      color: var(--text-secondary);
      font-size: 0.95em;
      word-break: break-word;
      opacity: 0.9;
    }

    .section {
      background: rgba(28, 31, 47, 0.92);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.25);
    }

    .section-title {
      font-size: 1.05em;
      font-weight: 900;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: rgba(220,239,255,0.95);
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .btn {
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      cursor: pointer;
      font-weight: 900;
      font-size: 0.95em;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color .2s ease, background .2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: rgba(2,5,21,0.35);
      color: var(--text-primary);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: scale(0.985); }

    .btn-primary {
      border: none;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 0 18px rgba(141, 23, 251, 0.25);
    }

    .btn-primary:hover { box-shadow: 0 0 24px rgba(141, 23, 251, 0.35); }

    .btn-danger {
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #ffd5d5;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px 20px;
      min-height: 70vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error */
    .error-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
    }
    .error-icon { font-size: 4em; margin-bottom: 14px; opacity: 0.55; }
    .error-message { margin-bottom: 18px; line-height: 1.5; }

    /* mini toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(28,31,47,0.95);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px 14px;
      border-radius: 999px;
      color: var(--text-primary);
      box-shadow: var(--shadow);
      display: none;
      z-index: 9999;
      max-width: 92vw;
      text-align: center;
      font-weight: 800;
      font-size: 13px;
    }

    @media (max-width: 768px) {
      body { padding: 16px; padding-bottom: 76px; }
      .profile-banner { padding: 28px 18px 86px; }
      .user-name { font-size: 1.55em; }
      .avatar { width: 110px; height: 110px; }
    }
  </style>

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script defer src="js/firebase-config.js"></script>

  <script>
    // ‚úÖ Mantener app=android en navegaci√≥n
    function withAppFlag(url) {
      const isAndroidApp =
        document.documentElement.classList.contains("android-app") ||
        document.body.classList.contains("android-app");

      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;

      const parts = url.split('#');
      const base = parts[0];
      const hash = parts[1] ? ('#' + parts[1]) : '';

      const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
      return fixed + hash;
    }
  </script>
</head>

<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>

  <div id="error" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <div class="error-message">
      <p>No se pudo cargar tu perfil</p>
      <p style="font-size: 0.9em; margin-top: 6px;">Verifica tu conexi√≥n e intenta de nuevo</p>
    </div>
    <button class="btn btn-primary" onclick="location.reload()">üîÑ Reintentar</button>
    <button class="btn" onclick="window.location.href=withAppFlag('inicio.html')" style="margin-top: 10px;">‚Üê Volver al inicio</button>
  </div>

  <div id="content" class="container" style="display:none;">
    <div class="top-bar">
      <button class="back-btn" onclick="window.location.href=withAppFlag('inicio.html')">‚Üê Volver al inicio</button>
    </div>

    <div class="profile-banner">
      <div class="avatar-container">
        <img id="avatar" class="avatar" src="images/logo-virtual-login.png" alt="Avatar" title="Toca para cambiar tu avatar">
        <div class="avatar-hint">Toca para cambiar avatar</div>
      </div>
    </div>

    <div class="profile-info">
      <h1 class="user-name" id="userName">Usuario</h1>
      <p class="user-email" id="userEmail"></p>
    </div>

    <div class="section">
      <h2 class="section-title">‚ö° Acciones</h2>
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="window.location.href=withAppFlag('inicio.html')">üéÆ Volver al inicio</button>
        <button class="btn" id="btnChangeAvatar">üñºÔ∏è Cambiar avatar</button>
        <button class="btn btn-danger" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ‚úÖ input oculto para seleccionar foto real -->
  <input id="avatarInput" type="file" accept="image/*" style="display:none;" />

  <script>
    const AVATAR_PLACEHOLDER = 'images/logo-virtual-login.png';
    const CACHE_KEY = 'vg_user_cache_profile';
    const CACHE_DURATION = 5 * 60 * 1000;

    const toast = (msg) => {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(() => el.style.display = 'none', 2400);
    };

    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
    }

    function safeSetAvatar(url) {
      const avatarEl = document.getElementById('avatar');

      const clean = (url && String(url).trim()) ? String(url).trim() : '';
      avatarEl.onerror = null;

      avatarEl.src = clean || AVATAR_PLACEHOLDER;

      avatarEl.onerror = () => {
        avatarEl.onerror = null;
        avatarEl.src = AVATAR_PLACEHOLDER;
      };
    }

    function getCachedUserData() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;
        const data = JSON.parse(cached);
        const age = Date.now() - data.timestamp;
        if (age < CACHE_DURATION) return data.user;
        localStorage.removeItem(CACHE_KEY);
        return null;
      } catch {
        return null;
      }
    }

    function setCachedUserData(userData) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ user: userData, timestamp: Date.now() }));
      } catch {}
    }

    function isFirebaseReady() {
      return typeof firebase !== 'undefined'
        && typeof firebase.auth === 'function'
        && typeof firebase.firestore === 'function'
        && typeof firebase.storage === 'function'
        && window.auth && window.db && window.storage;
    }

    function waitForFirebase(callback, maxAttempts = 30) {
      let attempts = 0;
      const check = setInterval(() => {
        attempts++;
        if (isFirebaseReady()) {
          clearInterval(check);
          callback();
        } else if (attempts >= maxAttempts) {
          clearInterval(check);
          console.error('Firebase timeout');
          showError();
        }
      }, 100);
    }

    function cacheBust(url) {
      const u = String(url || '').trim();
      if (!u) return u;
      const sep = u.includes('?') ? '&' : '?';
      return u + sep + 'v=' + Date.now();
    }

    function loadBasicUserData(user) {
      document.getElementById('userName').textContent = user.displayName || 'Usuario';
      document.getElementById('userEmail').textContent = user.email || '';

      // üëá important√≠simo: a veces el navegador cachea el jpg viejo
      safeSetAvatar(cacheBust(user.photoURL) || AVATAR_PLACEHOLDER);

      document.getElementById('avatar').onclick = openAvatarPicker;
      document.getElementById('btnChangeAvatar').onclick = openAvatarPicker;

      showContent();
    }

    async function loadFirestoreData(user) {
      try {
        // 1) cache
        const cached = getCachedUserData();
        if (cached?.photoURL) {
          safeSetAvatar(cacheBust(cached.photoURL));
          // update background
          fetchAndUpdateFirestore(user, true);
          return;
        }
        // 2) firestore
        await fetchAndUpdateFirestore(user, false);
      } catch (e) {
        console.warn('Firestore load warning:', e);
      }
    }

    async function fetchAndUpdateFirestore(user, silent = false) {
      const ref = window.db.collection('users').doc(user.uid);
      const snap = await ref.get();
      if (!snap.exists) return;

      const data = snap.data() || {};
      setCachedUserData(data);

      if (data.photoURL) {
        safeSetAvatar(cacheBust(data.photoURL));
      } else if (!silent) {
        // si no tiene photoURL, mantener el de auth o placeholder
      }
    }

    function checkAuth() {
      waitForFirebase(() => {
        window.auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = withAppFlag('index.html');
            return;
          }
          loadBasicUserData(user);
          await loadFirestoreData(user);
        });
      });
    }

    // ---------------------------
    // ‚úÖ SUBIR AVATAR REAL (Storage)
    // ---------------------------
    function openAvatarPicker() {
      const user = window.auth?.currentUser;
      if (!user) return;

      const input = document.getElementById('avatarInput');
      input.value = '';
      input.click();
    }

    function loadImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Imagen inv√°lida')); };
        img.src = url;
      });
    }

    async function compressImageToJpeg(file, maxSize = 512, quality = 0.75) {
      const img = await loadImageFromFile(file);

      const width = img.naturalWidth || img.width;
      const height = img.naturalHeight || img.height;

      const scale = Math.min(maxSize / width, maxSize / height, 1);
      const newW = Math.max(1, Math.round(width * scale));
      const newH = Math.max(1, Math.round(height * scale));

      const canvas = document.createElement('canvas');
      canvas.width = newW;
      canvas.height = newH;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, newW, newH);

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), 'image/jpeg', quality);
      });

      if (!blob) throw new Error('No se pudo comprimir la imagen');
      return blob;
    }

    async function uploadAvatarBlob(user, blob) {
      // reemplaza siempre => no acumula archivos
      const path = `avatars/${user.uid}.jpg`;

      const ref = window.storage.ref().child(path);
      const metadata = {
        contentType: 'image/jpeg',
        cacheControl: 'public, max-age=3600' // 1h
      };

      await ref.put(blob, metadata);
      return await ref.getDownloadURL();
    }

    async function setAvatarEverywhere(user, photoURL) {
      await user.updateProfile({ photoURL });

      await window.db.collection('users').doc(user.uid).set({
        photoURL,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      setCachedUserData({ photoURL });
    }

    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const user = window.auth?.currentUser;
      if (!user) return;

      // preview local inmediata
      try {
        const localUrl = URL.createObjectURL(file);
        safeSetAvatar(localUrl);
        setTimeout(() => URL.revokeObjectURL(localUrl), 5000);
      } catch {}

      try {
        toast('Subiendo avatar...');

        // 1) comprimir
        const blob = await compressImageToJpeg(file, 512, 0.75);

        // 2) subir
        const url = await uploadAvatarBlob(user, blob);

        // 3) guardar
        await setAvatarEverywhere(user, url);

        // 4) refrescar (cache bust)
        safeSetAvatar(cacheBust(url));

        toast('‚úÖ Avatar actualizado');
      } catch (err) {
        console.error('Error subiendo avatar:', err);
        toast('‚ùå No se pudo subir el avatar');
        safeSetAvatar(cacheBust(user.photoURL) || AVATAR_PLACEHOLDER);
      }
    });

    function logout() {
      if (!confirm('¬øSeguro que quieres cerrar sesi√≥n?')) return;

      try { localStorage.removeItem(CACHE_KEY); } catch {}

      if (window.auth) {
        window.auth.signOut()
          .then(() => window.location.href = withAppFlag('index.html'))
          .catch(() => window.location.href = withAppFlag('index.html'));
      } else {
        window.location.href = withAppFlag('index.html');
      }
    }

    window.addEventListener('load', checkAuth);
  </script>
</body>
</html>
