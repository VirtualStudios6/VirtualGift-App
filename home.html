<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#06011c">
  <title>Mi Perfil - VirtualGift</title>

  <!-- ‚úÖ Android App Mode (marca html/body con class android-app si viene ?app=android) -->
  <script defer src="js/app-mode.js"></script>

  <style>
    :root {
      --primary: #8d17fb;
      --secondary: #70189b;
      --bg-primary: #020515;
      --bg-secondary: #06011c;
      --bg-card: #1c1f2f;
      --text-primary: #dcefff;
      --text-secondary: #b6c6d9;
      --border: #293244;
      --shadow-card: 0 6px 25px rgba(0,0,0,0.5);
      --success: #10b981;
      --warning: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Roboto', sans-serif; }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
      color: var(--text-primary);
      padding: 20px;
      padding-bottom: 60px;
    }

    .container { max-width: 1000px; margin: 0 auto; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

    .back-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: transparent; border: 1px solid var(--border);
      color: var(--text-primary); padding: 10px 20px;
      border-radius: 10px; cursor: pointer; font-size: 14px;
      transition: all 0.3s ease;
    }
    .back-btn:hover { background: var(--bg-card); border-color: var(--primary); }

    .profile-banner {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 20px;
      padding: 40px 30px 100px;
      position: relative;
      margin-bottom: 80px;
      box-shadow: var(--shadow-card);
    }

    .avatar-container {
      position: absolute; bottom: -60px; left: 50%;
      transform: translateX(-50%); z-index: 3;
    }

    .avatar {
      width: 120px; height: 120px; border-radius: 50%;
      border: 5px solid var(--bg-primary);
      box-shadow: 0 0 30px rgba(141, 23, 251, 0.5);
      cursor: pointer; transition: transform 0.3s ease;
      object-fit: cover;
      background: rgba(255,255,255,0.06);
    }
    .avatar:hover { transform: scale(1.05); }

    .profile-info { text-align: center; margin-top: 80px; }

    .user-name { font-size: 2em; font-weight: bold; margin-bottom: 8px; }
    .user-email { color: var(--text-secondary); font-size: 0.95em; margin-bottom: 20px; }

    .profile-badges { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .badge {
      background: rgba(255, 255, 255, 0.1);
      padding: 6px 16px; border-radius: 20px;
      font-size: 0.85em; display: flex; align-items: center; gap: 6px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border-color: var(--primary);
    }

    .stat-icon { font-size: 2.5em; margin-bottom: 10px; }
    .stat-value {
      font-size: 2em; font-weight: bold;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 5px;
    }
    .stat-label { color: var(--text-secondary); font-size: 0.9em; }

    .section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .activity-item {
      display: flex; align-items: center; gap: 15px;
      padding: 15px;
      background: rgba(141, 23, 251, 0.05);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: background 0.3s ease;
    }
    .activity-item:hover { background: rgba(141, 23, 251, 0.1); }

    .activity-icon {
      width: 40px; height: 40px; background: var(--primary);
      border-radius: 10px; display: flex; align-items: center;
      justify-content: center; font-size: 1.2em;
    }
    .activity-info { flex: 1; }
    .activity-title { font-weight: 600; margin-bottom: 3px; }
    .activity-time { font-size: 0.85em; color: var(--text-secondary); }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(141, 23, 251, 0.6); }

    .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); }
    .btn-secondary:hover { background: rgba(28, 31, 47, 1); border-color: var(--primary); }

    .btn-danger { background: transparent; border: 1px solid #ef4444; color: #ef4444; }
    .btn-danger:hover { background: #ef4444; color: white; }

    /* ‚úÖ NUEVO: Loading optimizado */
    .loading {
      text-align: center;
      padding: 40px 20px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚úÖ NUEVO: Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .skeleton-text { height: 20px; margin-bottom: 10px; }
    .skeleton-title { height: 32px; width: 60%; margin: 0 auto 15px; }
    .skeleton-badge { height: 30px; width: 100px; display: inline-block; margin: 0 5px; }

    /* ‚úÖ NUEVO: Error state */
    .error-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .error-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.5; }
    .error-message { margin-bottom: 20px; line-height: 1.6; }

    @media (max-width: 768px) {
      .profile-banner { padding: 30px 20px 80px; }
      .user-name { font-size: 1.5em; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .action-buttons { grid-template-columns: 1fr; }
    }
  </style>

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>

  <script>
    // ‚úÖ Mantener app=android en navegaci√≥n
    function withAppFlag(url) {
      const isAndroidApp =
        document.documentElement.classList.contains("android-app") ||
        document.body.classList.contains("android-app");

      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;

      const parts = url.split('#');
      const base = parts[0];
      const hash = parts[1] ? ('#' + parts[1]) : '';

      const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
      return fixed + hash;
    }
  </script>
</head>

<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>

  <!-- ‚úÖ NUEVO: Error state -->
  <div id="error" class="error-state" style="display:none;">
    <div class="error-icon">‚ö†Ô∏è</div>
    <div class="error-message">
      <p>No se pudo cargar tu perfil</p>
      <p style="font-size: 0.9em; margin-top: 10px;">Por favor, verifica tu conexi√≥n e intenta de nuevo</p>
    </div>
    <button class="btn btn-primary" onclick="location.reload()">üîÑ Reintentar</button>
    <button class="btn btn-secondary" onclick="window.location.href=withAppFlag('inicio.html')" style="margin-top: 10px;">‚Üê Volver al inicio</button>
  </div>

  <div id="content" class="container" style="display:none;">
    <div class="top-bar">
      <button class="back-btn" onclick="window.location.href=withAppFlag('inicio.html')">‚Üê Volver al inicio</button>
    </div>

    <div class="profile-banner">
      <div class="avatar-container">
        <img id="avatar" class="avatar" src="https://via.placeholder.com/120" alt="Avatar">
      </div>
    </div>

    <div class="profile-info">
      <h1 class="user-name" id="userName">Usuario</h1>
      <p class="user-email" id="userEmail">correo@ejemplo.com</p>

      <div class="profile-badges">
        <span class="badge" id="providerBadge">
          <span id="providerIcon">üîê</span>
          <span id="provider">Email</span>
        </span>

        <span class="badge">
          ‚è±Ô∏è <span id="lastLogin">‚Äî</span>
        </span>

        <span class="badge">
          üìÖ Miembro desde <span id="memberSince">‚Äî</span>
        </span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card" onclick="window.location.href=withAppFlag('puntos.html')">
        <div class="stat-icon">ü™ô</div>
        <div class="stat-value" id="totalPoints">0</div>
        <div class="stat-label">VirtualCoins</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üéÆ</div>
        <div class="stat-value" id="gamesPlayed">0</div>
        <div class="stat-label">Juegos Jugados</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-value" id="achievements">0</div>
        <div class="stat-label">Logros</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">üéÅ</div>
        <div class="stat-value" id="sorteos">0</div>
        <div class="stat-label">Sorteos Participados</div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">üìä Actividad Reciente</h2>
      <div id="activityContainer">
        <div class="activity-item">
          <div class="activity-icon">üéâ</div>
          <div class="activity-info">
            <div class="activity-title">¬°Bienvenido a VirtualGift!</div>
            <div class="activity-time">Hace unos momentos</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">‚ö° Acciones R√°pidas</h2>
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="window.location.href=withAppFlag('inicio.html')">üéÆ Explorar VirtualGift</button>
        <button class="btn btn-secondary" onclick="window.location.href=withAppFlag('puntos.html')">ü™ô Ver mis Puntos</button>
        <button class="btn btn-secondary" onclick="editProfile()">‚úèÔ∏è Editar Perfil</button>
        <button class="btn btn-danger" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ OPTIMIZACI√ìN 1: Cache local para datos del usuario
    const CACHE_KEY = 'vg_user_cache';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

    function getCachedUserData() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (!cached) return null;

        const data = JSON.parse(cached);
        const age = Date.now() - data.timestamp;

        if (age < CACHE_DURATION) {
          console.log('‚úÖ Usando datos en cach√© (edad:', Math.floor(age/1000), 's)');
          return data.user;
        }

        localStorage.removeItem(CACHE_KEY);
        return null;
      } catch (e) {
        console.warn('Error al leer cach√©:', e);
        return null;
      }
    }

    function setCachedUserData(userData) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          user: userData,
          timestamp: Date.now()
        }));
      } catch (e) {
        console.warn('Error al guardar cach√©:', e);
      }
    }

    // ‚úÖ OPTIMIZACI√ìN 2: Provider labels
    function providerLabel(provider) {
      if (provider === 'google.com') return { icon: 'üîµ', text: 'Google' };
      if (provider === 'facebook.com') return { icon: 'üìò', text: 'Facebook' };
      return { icon: 'üîê', text: 'Email' };
    }

    function formatLastLogin(ts) {
      if (!ts) return '‚Äî';
      const date = ts.toDate ? ts.toDate() : new Date(ts);
      const now = new Date();
      const diffMin = Math.floor((now - date) / 1000 / 60);

      if (diffMin < 1) return 'Ahora';
      if (diffMin < 60) return `Hace ${diffMin} min`;
      if (diffMin < 1440) return `Hace ${Math.floor(diffMin / 60)}h`;
      return date.toLocaleDateString('es-ES');
    }

    function formatMemberSince(ts) {
      if (!ts) return '‚Äî';
      const date = ts.toDate ? ts.toDate() : new Date(ts);
      return date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
    }

    // ‚úÖ OPTIMIZACI√ìN 3: Mostrar contenido inmediatamente
    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
    }

    // ‚úÖ OPTIMIZACI√ìN 4: Cargar UI primero con datos b√°sicos del usuario
    function loadBasicUserData(user) {
      // Datos inmediatos de Firebase Auth
      document.getElementById('userName').textContent = user.displayName || 'Usuario';
      document.getElementById('userEmail').textContent = user.email || '';
      document.getElementById('avatar').src = user.photoURL || 'https://via.placeholder.com/120';

      // Mostrar UI inmediatamente
      showContent();

      console.log('‚úÖ UI cargada con datos b√°sicos');
    }

    // ‚úÖ OPTIMIZACI√ìN 5: Cargar datos de Firestore en paralelo
    async function loadFirestoreData(user) {
      try {
        // Primero intentar cach√©
        const cachedData = getCachedUserData();
        if (cachedData) {
          updateUIWithData(cachedData);
          console.log('‚úÖ Datos cargados desde cach√©');

          // Actualizar en segundo plano
          fetchAndUpdateFirestore(user, true);
          return;
        }

        // Si no hay cach√©, cargar de Firestore
        await fetchAndUpdateFirestore(user, false);

      } catch (e) {
        console.error('Error al cargar datos de Firestore:', e);
        // No mostrar error si ya tenemos datos b√°sicos
      }
    }

    async function fetchAndUpdateFirestore(user, silent = false) {
      try {
        const ref = window.db.collection('users').doc(user.uid);
        const snap = await ref.get();

        if (!snap.exists) {
          if (!silent) console.warn('Usuario no existe en Firestore');
          return;
        }

        const data = snap.data() || {};

        // Guardar en cach√©
        setCachedUserData(data);

        // Actualizar UI
        updateUIWithData(data);

        if (!silent) console.log('‚úÖ Datos de Firestore actualizados');

      } catch (e) {
        console.error('Error fetchAndUpdateFirestore:', e);
        throw e;
      }
    }

    function updateUIWithData(data) {
      // Provider
      const p = providerLabel(data.provider || 'email');
      document.getElementById('providerIcon').textContent = p.icon;
      document.getElementById('provider').textContent = p.text;

      // Fechas
      document.getElementById('lastLogin').textContent = formatLastLogin(data.lastLogin);
      document.getElementById('memberSince').textContent = formatMemberSince(data.createdAt);

      // Stats
      document.getElementById('totalPoints').textContent = (data.points || 0).toLocaleString();
      document.getElementById('gamesPlayed').textContent = data.gamesPlayed || 0;
      document.getElementById('achievements').textContent = data.achievements || 0;
      document.getElementById('sorteos').textContent = data.sorteosParticipados || 0;
    }

    // ‚úÖ OPTIMIZACI√ìN 6: Firebase ready check con timeout corto
    function isFirebaseReady() {
      return typeof firebase !== 'undefined'
        && typeof firebase.auth === 'function'
        && typeof firebase.firestore === 'function'
        && window.auth && window.db;
    }

    function waitForFirebase(callback, maxAttempts = 30) { // ‚úÖ Reducido de 60 a 30
      let attempts = 0;
      const check = setInterval(() => {
        attempts++;
        if (isFirebaseReady()) {
          clearInterval(check);
          callback();
        } else if (attempts >= maxAttempts) {
          clearInterval(check);
          console.error('Firebase timeout');
          showError();
        }
      }, 100);
    }

    // ‚úÖ OPTIMIZACI√ìN 7: Auth check optimizado
    function checkAuth() {
      waitForFirebase(() => {
        window.auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = withAppFlag('index.html');
            return;
          }

          // ‚úÖ Cargar UI inmediatamente con datos b√°sicos
          loadBasicUserData(user);

          // ‚úÖ Cargar datos adicionales en segundo plano
          await loadFirestoreData(user);
        });
      });
    }

    function editProfile() {
      alert('Funci√≥n de editar perfil pr√≥ximamente...\n\n¬øQu√© te gustar√≠a editar?\n- Foto de perfil\n- Nombre de usuario\n- Preferencias');
    }

    function logout() {
      if (!confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) return;

      // Limpiar cach√©
      try {
        localStorage.removeItem(CACHE_KEY);
      } catch (e) {
        console.warn('Error limpiando cach√©:', e);
      }

      if (window.auth) {
        window.auth.signOut()
          .then(() => window.location.href = withAppFlag('index.html'))
          .catch(() => window.location.href = withAppFlag('index.html'));
      } else {
        window.location.href = withAppFlag('index.html');
      }
    }

    // ‚úÖ Iniciar cuando cargue la p√°gina
    window.addEventListener('load', checkAuth);
  </script>
</body>
</html>
