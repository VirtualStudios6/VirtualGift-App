<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#06011c">
    <title>Mis Puntos - VirtualGift</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400;0,14..32,500;0,14..32,600;0,14..32,700;0,14..32,800;0,14..32,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/inicio.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/puntos.css">

    <script defer src="js/app-mode.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script defer src="js/firebase-config.js"></script>

    <script>
        function withAppFlag(url) {
            const isAndroidApp =
                document.documentElement.classList.contains("android-app") ||
                document.body.classList.contains("android-app");
            if (!isAndroidApp) return url;
            if (url.includes("app=android")) return url;
            const parts = url.split('#');
            const base  = parts[0];
            const hash  = parts[1] ? ('#' + parts[1]) : '';
            const fixed = base.includes("?") ? (base + "&app=android") : (base + "?app=android");
            return fixed + hash;
        }
    </script>

    <style>
        /* ===== CHECK-IN RACHA ===== */
        .checkin-card {
            border-radius: 18px; overflow: hidden; position: relative;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            border: 1px solid rgba(139,92,246,0.3);
            padding: 18px; margin-bottom: 20px;
        }
        .checkin-card::before {
            content: ''; position: absolute; top: -40px; right: -40px;
            width: 150px; height: 150px; border-radius: 50%;
            background: rgba(139,92,246,0.15); filter: blur(30px); pointer-events: none;
        }
        .checkin-top {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 14px;
        }
        .checkin-title { font-size: 16px; font-weight: 800; color: white; }
        .checkin-streak {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,200,55,0.15); border: 1px solid rgba(255,200,55,0.3);
            border-radius: 20px; padding: 4px 10px;
            font-size: 12px; font-weight: 700; color: #ffc837;
        }
        .checkin-days {
            display: flex; gap: 6px; margin-bottom: 14px;
        }
        .checkin-day {
            flex: 1; border-radius: 10px; padding: 8px 4px; text-align: center;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
        }
        .checkin-day.done {
            background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.5);
        }
        .checkin-day.today {
            background: rgba(139,92,246,0.3); border-color: #8b5cf6;
            box-shadow: 0 0 12px rgba(139,92,246,0.4);
        }
        .checkin-day-label {
            font-size: 9px; color: rgba(255,255,255,0.5); font-weight: 600;
        }
        .checkin-day.today .checkin-day-label { color: #c4b5fd; }
        .checkin-day-coins {
            font-size: 11px; font-weight: 800; color: #ffc837; margin-top: 3px;
        }
        .checkin-day.done .checkin-day-coins::before { content: '‚úì '; }
        .checkin-btn {
            width: 100%; padding: 13px; border-radius: 12px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border: none; color: white; font-size: 15px; font-weight: 800;
            cursor: pointer; transition: opacity 0.2s; font-family: inherit;
        }
        .checkin-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .checkin-btn:active:not(:disabled) { transform: scale(0.98); }

        /* ===== TOAST ===== */
        .vc-toast {
            position: fixed; bottom: 90px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1e1b4b; border: 1px solid rgba(139,92,246,0.4);
            border-radius: 12px; padding: 12px 20px;
            font-size: 14px; font-weight: 700; color: white;
            opacity: 0; transition: all 0.3s; z-index: 9999;
            white-space: nowrap;
        }
        .vc-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>

<body>
    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <img src="images/logo-virtual-login.png" alt="VirtualGift Logo" class="logo-image">
            <span class="logo-text">VIRTUAL<span class="logo-studios">GIFT</span></span>
        </div>
        <div class="header-icons">
            <div class="icon-users" onclick="window.location.href=withAppFlag('home.html')" style="cursor:pointer;">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <div class="icon-coin" onclick="window.location.href=withAppFlag('puntos.html')" style="cursor:pointer;">
                <svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="48" fill="#FDB813"/>
                    <defs><radialGradient id="cg"><stop offset="0%" style="stop-color:#FFD700"/><stop offset="100%" style="stop-color:#FFA500"/></radialGradient></defs>
                    <circle cx="50" cy="50" r="42" fill="url(#cg)"/>
                    <path d="M 30 30 L 42 65 L 50 65 L 58 65 L 70 30 L 62 30 L 54 57 L 50 57 L 46 57 L 38 30 Z" fill="#FFFACD"/>
                </svg>
            </div>
            <div class="icon-notification" onclick="window.location.href=withAppFlag('notificaciones.html')" style="cursor:pointer;">
                <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
            </div>
        </div>
    </header>

    <div class="points-container">

        <button class="back-button" onclick="window.location.href=withAppFlag('inicio.html')">
            ‚Üê Volver al inicio
        </button>

        <!-- BALANCE -->
        <div class="points-header">
            <div class="points-icon">
                <svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="48" fill="#FDB813"/>
                    <defs><radialGradient id="cg2"><stop offset="0%" style="stop-color:#FFD700"/><stop offset="100%" style="stop-color:#FFA500"/></radialGradient></defs>
                    <circle cx="50" cy="50" r="42" fill="url(#cg2)"/>
                    <path d="M 30 30 L 42 65 L 50 65 L 58 65 L 70 30 L 62 30 L 54 57 L 50 57 L 46 57 L 38 30 Z" fill="#FFFACD"/>
                </svg>
            </div>
            <div class="points-label">Tus VirtualCoins</div>
            <div class="points-balance" id="totalPoints">‚Äî</div>
            <div class="points-conversion">‚âà $<span id="dollarValue">0.00</span> USD</div>
        </div>

        <!-- ===== CHECK-IN RACHA (reemplaza la daily card simple) ===== -->
        <div class="checkin-card">
            <div class="checkin-top">
                <div class="checkin-title">üî• Recompensa Diaria</div>
                <div class="checkin-streak" id="streakBadge">üî• 0 d√≠as</div>
            </div>
            <div class="checkin-days" id="checkinDays"></div>
            <button class="checkin-btn" id="checkinBtn" onclick="doCheckin()" disabled>
                Cargando...
            </button>
        </div>

        <!-- CANJE -->
        <div class="section-header">
            <h2 class="section-title">üéØ Canjear VirtualCoins</h2>
        </div>

        <div class="redeem-section">

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">¬øCu√°ntos VirtualCoins quieres canjear?</label>
                <div class="redeem-input-wrap">
                    <span class="coin-prefix">ü™ô</span>
                    <input
                        type="number"
                        id="redeemPoints"
                        class="redeem-points-input"
                        placeholder="20000"
                        min="20000"
                        step="1000"
                        autocomplete="off"
                    />
                </div>
                <div class="redeem-usd-preview" id="redeemUsdPreview">$0.00 USD</div>
                <div class="redeem-error" id="redeemError"></div>
                <div class="redeem-hint">M√≠nimo 20.000 ¬∑ M√∫ltiplo de 1.000 ¬∑ 1.000 puntos = $1 USD</div>
            </div>

            <label class="form-label" style="display:block; margin-bottom: 10px;">
                ¬øD√≥nde quieres recibir el dinero?
            </label>

            <div class="platforms-grid">
                <div class="platform-card platform-disabled" data-platform="paypal">
                    <span class="platform-emoji">üí∞</span>
                    <span class="platform-name">PayPal</span>
                </div>
                <div class="platform-card platform-disabled" data-platform="amazon">
                    <span class="platform-emoji">üì¶</span>
                    <span class="platform-name">Amazon Gift Card</span>
                </div>
                <div class="platform-card platform-disabled" data-platform="steam">
                    <span class="platform-emoji">üéÆ</span>
                    <span class="platform-name">Steam Wallet</span>
                </div>
                <div class="platform-card platform-disabled" data-platform="googleplay">
                    <span class="platform-emoji">‚ñ∂Ô∏è</span>
                    <span class="platform-name">Google Play</span>
                </div>
                <div class="platform-card platform-disabled" data-platform="psn">
                    <span class="platform-emoji">üïπÔ∏è</span>
                    <span class="platform-name">PSN</span>
                </div>
            </div>

            <button class="proceed-btn" id="proceedRedeemBtn" disabled>
                Selecciona una plataforma
            </button>

        </div>

    </div>

    <!-- MODAL DE CANJE -->
    <div id="redeemModal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalPlatformName">Canjear</h3>
                <button class="modal-close" id="closeRedeemModal">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="modal-summary">
                    <div class="summary-row">
                        <span class="summary-label">VirtualCoins a canjear</span>
                        <span class="summary-value" id="modalRedeemPoints">‚Äî</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Recibir√°s</span>
                        <span class="summary-value" id="modalRedeemUSD">‚Äî</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Tiempo estimado</span>
                        <span class="summary-value">24 ‚Äì 48 horas</span>
                    </div>
                </div>
                <form id="redeemForm" class="redeem-form">
                    <div class="form-group">
                        <label class="form-label">Nombre completo</label>
                        <input type="text" id="redeemFullName" class="form-input"
                            placeholder="Ej: Juan P√©rez" autocomplete="name" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="redeemAccountLabel">Cuenta</label>
                        <input type="text" id="redeemAccount" class="form-input" placeholder="" required />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelRedeemBtn">Cancelar</button>
                        <button type="submit"  class="btn btn-primary"   id="confirmRedeemBtn">Confirmar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="vc-toast" id="vcToast"></div>

    <script defer src="js/puntos.js"></script>

    <script>
        // ===== COINS DIARIOS POR D√çA DE RACHA =====
        const CHECKIN_REWARDS = [10, 15, 20, 25, 30, 40, 75];

        function showVcToast(msg, duration = 2800) {
            const t = document.getElementById('vcToast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }

        function buildCheckinUI(streak, alreadyDone) {
            const days  = document.getElementById('checkinDays');
            const btn   = document.getElementById('checkinBtn');
            const badge = document.getElementById('streakBadge');

            badge.textContent = `üî• ${streak} d√≠a${streak !== 1 ? 's' : ''}`;

            let html = '';
            CHECKIN_REWARDS.forEach((coins, i) => {
                const done    = i < (streak % 7);
                const isToday = (i === (streak % 7)) && !alreadyDone;
                let cls = 'checkin-day';
                if (done)    cls += ' done';
                if (isToday) cls += ' today';
                html += `<div class="${cls}">
                    <div class="checkin-day-label">D√≠a ${i + 1}</div>
                    <div class="checkin-day-coins">ü™ô${coins}</div>
                </div>`;
            });
            days.innerHTML = html;

            if (alreadyDone) {
                btn.textContent = '‚úÖ Ya reclamaste hoy';
                btn.disabled = true;
            } else {
                const reward = CHECKIN_REWARDS[streak % 7];
                btn.textContent = `üéÅ Reclamar +${reward} coins`;
                btn.disabled = false;
            }
        }

        async function loadCheckin(user) {
            try {
                const snap = await window.db.collection('users').doc(user.uid).get();
                const data = snap.data() || {};
                const streak = data.checkinStreak || 0;
                const lastCheckin = data.lastCheckin?.toDate?.() || null;
                const alreadyDone = lastCheckin &&
                    lastCheckin.toDateString() === new Date().toDateString();
                buildCheckinUI(streak, alreadyDone);
            } catch(e) {
                console.error('loadCheckin error:', e);
                const btn = document.getElementById('checkinBtn');
                btn.textContent = 'Error al cargar';
            }
        }

        async function doCheckin() {
            const user = window._vcCurrentUser;
            if (!user) return;
            const btn = document.getElementById('checkinBtn');
            btn.disabled = true; btn.textContent = 'Procesando...';

            try {
                const userRef = window.db.collection('users').doc(user.uid);
                const snap    = await userRef.get();
                const data    = snap.data() || {};

                const streak      = data.checkinStreak || 0;
                const lastCheckin = data.lastCheckin?.toDate?.() || null;
                const now         = new Date();
                const todayStr    = now.toDateString();
                const yesterdayStr= new Date(now - 86400000).toDateString();

                if (lastCheckin && lastCheckin.toDateString() === todayStr) {
                    showVcToast('‚úÖ Ya reclamaste hoy');
                    buildCheckinUI(streak, true);
                    return;
                }

                const consecutive = lastCheckin && lastCheckin.toDateString() === yesterdayStr;
                const newStreak   = consecutive ? streak + 1 : 1;
                const reward      = CHECKIN_REWARDS[(newStreak - 1) % 7];
                const currentPts  = data.points || 0;
                const newPts      = currentPts + reward;

                await userRef.set({
                    checkinStreak: newStreak,
                    lastCheckin: firebase.firestore.Timestamp.now(),
                    points: newPts,
                }, { merge: true });

                await window.db.collection('pointsHistory').add({
                    userId: user.uid,
                    type: 'daily_checkin',
                    points: reward,
                    streak: newStreak,
                    createdAt: firebase.firestore.Timestamp.now(),
                });

                // Actualizar balance en pantalla
                const balanceEl = document.getElementById('totalPoints');
                const dollarEl  = document.getElementById('dollarValue');
                if (balanceEl) balanceEl.textContent = newPts.toLocaleString();
                if (dollarEl)  dollarEl.textContent  = (newPts / 1000).toFixed(2);

                showVcToast(`üéâ +${reward} coins! Racha: ${newStreak} d√≠as üî•`);
                buildCheckinUI(newStreak, true);
            } catch(e) {
                console.error('doCheckin error:', e);
                showVcToast('‚ùå Error al reclamar');
                btn.disabled = false;
                btn.textContent = 'Intentar de nuevo';
            }
        }

        // Esperar Firebase + exponer usuario para el check-in
        function waitForFirebaseAndDb(cb, max = 80) {
            let i = 0;
            const t = setInterval(() => {
                i++;
                if (typeof firebase !== 'undefined' &&
                    typeof firebase.auth === 'function' &&
                    window.db) { clearInterval(t); cb(); }
                else if (i >= max) clearInterval(t);
            }, 100);
        }

        window.addEventListener('load', () => {
            waitForFirebaseAndDb(() => {
                firebase.auth().onAuthStateChanged(user => {
                    if (!user) { window.location.href = withAppFlag('index.html'); return; }
                    window._vcCurrentUser = user;
                    loadCheckin(user);
                });
            });
        });
    </script>
</body>
</html>
