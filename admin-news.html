<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üõ† Panel de Noticias - VirtualGift</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#06011c" />

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="js/firebase-config.js"></script>

  <style>
    :root{
      --bg1:#020515;
      --bg2:#06011c;
      --card:#1c1f2f;
      --text:#dcefff;
      --muted:#b6c6d9;
      --border:#293244;
      --primary:#8d17fb;
      --danger:#ef4444;
      --success:#10b981;
      --warning:#f59e0b;
      --shadow: 0 10px 35px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Roboto,Arial,sans-serif;}
    body{
      min-height:100vh;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:16px;
    }
    .title{font-size:22px;font-weight:900;letter-spacing:.02em;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px;}
    .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .btn{
      border:none;cursor:pointer;border-radius:12px;
      padding:10px 14px;font-weight:800;
      background:rgba(255,255,255,.06);color:var(--text);
      border:1px solid rgba(255,255,255,.08);
      transition:.2s;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:rgba(141,23,251,.45);}
    .btn-primary{background:linear-gradient(90deg,var(--primary),#70189b);border:none;}
    .btn-danger{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#ffd5d5;}
    .btn-success{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);color:#d9fff0;}
    .btn-warning{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35);color:#ffe9c2;}

    .grid{
      display:grid;
      grid-template-columns: 470px 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:rgba(28,31,47,.9);
      border:1px solid rgba(41,50,68,.7);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 8px 28px rgba(0,0,0,.35);
    }
    .card h2{
      font-size:16px;font-weight:900;margin-bottom:10px;
      display:flex;align-items:center;gap:10px;
    }
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
    }

    label{display:block;margin-top:10px;font-size:12px;color:var(--muted);}
    input, textarea, select{
      width:100%;margin-top:6px;padding:10px 12px;
      border-radius:12px;border:1px solid rgba(255,255,255,.08);
      background:rgba(2,5,21,.35);color:var(--text);
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.5;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:520px){ .row{grid-template-columns:1fr;} }

    .preview{
      margin-top:10px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(2,5,21,.35);
      height:180px;display:flex;align-items:center;justify-content:center;
      color:rgba(220,239,255,.7);
    }
    .preview img{width:100%;height:100%;object-fit:cover;display:block;}
    .muted{color:var(--muted);font-size:12px;}

    /* ‚úÖ contador feedTitle */
    .feed-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .counter{
      font-size:12px;
      color:var(--muted);
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.07);
    }
    .counter.warn{
      color:#ffd5d5;
      border-color:rgba(239,68,68,.35);
      background:rgba(239,68,68,.10);
    }

    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;align-items:center;}
    .filters .chip{
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      cursor:pointer;font-weight:800;font-size:12px;color:var(--text);
    }
    .chip.active{border-color:rgba(141,23,251,.6); box-shadow:0 0 0 3px rgba(141,23,251,.12);}
    .list{display:grid;gap:10px;}
    .item{
      display:grid;grid-template-columns: 92px 1fr;gap:12px;
      padding:10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(2,5,21,.22);
    }
    .thumb{
      width:92px;height:92px;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(28,31,47,.8);
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .meta{display:flex;flex-direction:column;gap:6px;}
    .meta strong{font-size:14px;line-height:1.2;}
    .meta .small{font-size:12px;color:var(--muted);line-height:1.2;}
    .item-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:10px 0;}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(28,31,47,.95);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 14px;border-radius:999px;
      color:var(--text);box-shadow:var(--shadow);
      display:none; z-index:9999;
      max-width:92vw;
    }

    /* -------- Bloques -------- */
    .block-tools{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .block-tools .btn{padding:9px 12px; font-size:12px;}
    .blocks{
      display:grid; gap:10px;
      margin-top:10px;
    }
    .block{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(2,5,21,.22);
      overflow:hidden;
    }
    .block-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      background:rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .block-type{
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      font-size:12px;
      color:rgba(220,239,255,.92);
    }
    .block-mini{
      font-size:11px; color:var(--muted);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.07);
      padding:3px 8px; border-radius:999px;
    }
    .block-actions{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .block-actions .btn{
      padding:7px 10px;
      border-radius:10px;
      font-size:12px;
    }
    .block-body{
      padding:10px;
    }
    .block-body textarea, .block-body input{
      margin-top:0;
    }
    .hint{
      font-size:12px;color:var(--muted);
      margin-top:8px;
      line-height:1.3;
    }

    /* previews extra */
    .mini-preview{
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(2,5,21,.35);
      height:140px;
      display:flex;align-items:center;justify-content:center;
      color:rgba(220,239,255,.7);
    }
    .mini-preview img{width:100%;height:100%;object-fit:cover;display:block;}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">üõ† VirtualNews</div>
      <div class="subtitle">Organiza las noticias del feed.</div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnGoHome">‚Üê Inicio</button>
      <button class="btn btn-danger" id="btnLogout">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="grid">
    <!-- FORM -->
    <section class="card">
      <h2>üìù Editor <span id="modeBadge" class="badge">Crear</span></h2>

      <label>T√≠tulo (dentro de la noticia)</label>
      <input id="fTitle" placeholder="El encabezado de la noticia." />

      <label>T√≠tulo del feed (corto)</label>
      <input id="fFeedTitle" placeholder="Titulo corto del feed." />

      <div class="feed-meta">
        <p class="muted">

        </p>
        <span id="feedCounter" class="counter">0/45</span>
      </div>

      <div class="row">
        <div>
          <label>Categor√≠a</label>
          <select id="fCategory">
            <option value="Gaming">Gaming</option>
            <option value="General">General</option>
          </select>
        </div>
        <div>
          <label>Estado</label>
          <select id="fPublished">
            <option value="true">Publicado</option>
            <option value="false">Borrador</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Imagen principal del Header (URL)</label>
          <input id="fHeaderImage" placeholder="https://..." />
        </div>
        <div>
          <label>Status (opcional)</label>
          <input id="fStatusText" placeholder="Noticia Exclusiva" />
        </div>
      </div>

      <div id="headerPreview" class="mini-preview">
        <span class="muted">Vista previa del header</span>
      </div>

      <label>Cover (URL) ‚Äî imagen del feed</label>
      <input id="fCover" placeholder="https://..." />

      <div id="coverPreview" class="preview">
        <span class="muted">Vista previa del cover</span>
      </div>

      <div class="sep"></div>

      <h2 style="margin-top:2px;">üß© Todo el contenido <span class="badge" id="blocksCount">0 bloques</span></h2>

      <div class="block-tools">
        <button class="btn" id="addP">+ P√°rrafo</button>
        <button class="btn" id="addH2">+ Subt√≠tulo (h2)</button>
        <button class="btn" id="addImg">+ Imagen</button>
        <button class="btn" id="addHi">+ Caja destacada</button>
        <button class="btn btn-warning" id="btnClearBlocks">Limpiar bloques</button>
      </div>

      <div id="blocks" class="blocks"></div>

      <p class="hint">
        Orden recomendado: <b>P√°rrafo</b> ‚Üí <b>Imagen</b> ‚Üí <b>P√°rrafo</b> ‚Üí <b>Caja destacada</b> ‚Üí <b>Subt√≠tulo</b> ‚Üí ...
      </p>

      <div class="sep"></div>

      <label>Galer√≠a (URLs separadas por coma o por l√≠neas) (opcional)</label>
      <textarea id="fGallery" placeholder="https://img1...\nhttps://img2...\nhttps://img3..."></textarea>

      <div class="sep"></div>

      <div class="row">
        <button class="btn btn-primary" id="btnSave">Guardar</button>
        <button class="btn" id="btnNew">Nueva</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn btn-success" id="btnPublishNow">Publicar ahora</button>
        <button class="btn btn-warning" id="btnUnpublish">Despublicar</button>
      </div>

      <button class="btn btn-danger" id="btnDelete" style="margin-top:10px;display:none;">Eliminar</button>

      <p class="muted" style="margin-top:10px;">
     ‚ÄúPublicar ahora‚Äù tambi√©n actualiza <b>date</b> para que suba al inicio del feed.
      </p>
    </section>

    <!-- LIST -->
    <section class="card">
      <h2>üì∞ Noticias <span id="countBadge" class="badge">0</span></h2>

      <div class="filters">
        <div class="chip active" data-filter="all">Todas</div>
        <div class="chip" data-filter="published">Publicadas</div>
        <div class="chip" data-filter="drafts">Borradores</div>
      </div>

      <div id="newsList" class="list"></div>
      <p id="emptyState" class="muted" style="display:none; padding:10px;">No hay noticias todav√≠a.</p>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  // -------- Utils UI --------
  const toast = (msg) => {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(() => el.style.display = 'none', 2600);
  };
  const qs = (id) => document.getElementById(id);

  function parseGallery(text) {
    const raw = String(text || '')
      .split(/\n|,/g)
      .map(s => s.trim())
      .filter(Boolean);
    return Array.from(new Set(raw));
  }

  function fmtDate(ts) {
    if (!ts) return '‚Äî';
    try {
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
    } catch { return '‚Äî'; }
  }

  function setImgPreview(elId, url, placeholderText){
    const box = qs(elId);
    const clean = (url && String(url).trim()) ? String(url).trim() : '';
    if (!clean) {
      box.innerHTML = `<span class="muted">${placeholderText}</span>`;
      return;
    }
    box.innerHTML = '<img alt="preview" loading="lazy">';
    box.querySelector('img').src = clean;
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ‚úÖ contador del feedTitle
  const FEED_MAX = 45;
  function updateFeedCounter() {
    const inp = qs('fFeedTitle');
    const c = qs('feedCounter');
    if (!inp || !c) return;
    const len = (inp.value || '').length;
    c.textContent = `${len}/${FEED_MAX}`;
    c.classList.toggle('warn', len > FEED_MAX);
  }

  // -------- Bloques (estado) --------
  let blocks = [];

  function blockLabel(type){
    if (type === 'p') return 'P√°rrafo';
    if (type === 'h2') return 'Subt√≠tulo (h2)';
    if (type === 'img') return 'Imagen';
    if (type === 'highlight') return 'Caja destacada';
    return type || 'Bloque';
  }

  function updateBlocksCount(){
    qs('blocksCount').textContent = `${blocks.length} bloques`;
  }

  function addBlock(type){
    if (type === 'p') blocks.push({ type:'p', text:'' });
    if (type === 'h2') blocks.push({ type:'h2', text:'' });
    if (type === 'img') blocks.push({ type:'img', url:'', caption:'' });
    if (type === 'highlight') blocks.push({ type:'highlight', text:'' });
    renderBlocks();
  }

  function moveBlock(i, dir){
    const j = i + dir;
    if (j < 0 || j >= blocks.length) return;
    const tmp = blocks[i];
    blocks[i] = blocks[j];
    blocks[j] = tmp;
    renderBlocks();
  }

  function deleteBlock(i){
    blocks.splice(i, 1);
    renderBlocks();
  }

  function renderBlocks(){
    const wrap = qs('blocks');
    wrap.innerHTML = '';

    blocks.forEach((b, i) => {
      const el = document.createElement('div');
      el.className = 'block';

      const head = document.createElement('div');
      head.className = 'block-head';
      head.innerHTML = `
        <div class="block-type">
          <span>${escapeHtml(blockLabel(b.type))}</span>
          <span class="block-mini">#${i+1}</span>
        </div>
        <div class="block-actions">
          <button class="btn" data-act="up" data-i="${i}">‚Üë</button>
          <button class="btn" data-act="down" data-i="${i}">‚Üì</button>
          <button class="btn btn-danger" data-act="del" data-i="${i}">Eliminar</button>
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'block-body';

      if (b.type === 'p') {
        body.innerHTML = `<textarea data-field="text" data-i="${i}" placeholder="Escribe el p√°rrafo...">${escapeHtml(b.text || '')}</textarea>`;
      }

      if (b.type === 'h2') {
        body.innerHTML = `<input data-field="text" data-i="${i}" placeholder="Ej: ¬øQu√© se descubri√≥?" value="${escapeHtml(b.text || '')}">`;
      }

      if (b.type === 'highlight') {
        body.innerHTML = `<textarea data-field="text" data-i="${i}" placeholder="Ej: üí° Dato clave: ...">${escapeHtml(b.text || '')}</textarea>`;
      }

      if (b.type === 'img') {
        body.innerHTML = `
          <input data-field="url" data-i="${i}" placeholder="URL de la imagen" value="${escapeHtml(b.url || '')}">
          <div style="height:8px"></div>
          <input data-field="caption" data-i="${i}" placeholder="Caption (opcional)" value="${escapeHtml(b.caption || '')}">
        `;
      }

      el.appendChild(head);
      el.appendChild(body);
      wrap.appendChild(el);
    });

    updateBlocksCount();
    qs('btnClearBlocks').disabled = blocks.length === 0;
  }

  // Delegaci√≥n eventos de bloques
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.getAttribute('data-act');
    const i = Number(btn.getAttribute('data-i'));
    if (Number.isNaN(i)) return;

    if (act === 'up') moveBlock(i, -1);
    if (act === 'down') moveBlock(i, 1);
    if (act === 'del') deleteBlock(i);
  });

  document.addEventListener('input', (e) => {
    const t = e.target;

    // ‚úÖ contador de feed title
    if (t && t.id === 'fFeedTitle') updateFeedCounter();

    const i = t.getAttribute('data-i');
    const field = t.getAttribute('data-field');
    if (i == null || !field) return;
    const idx = Number(i);
    if (!blocks[idx]) return;

    blocks[idx][field] = t.value;
  });

  // -------- Firebase / Auth / Admin --------
  let currentUser = null;
  let selectedId = null;
  let lastDocs = [];
  let currentFilter = 'all';

  function requireFirebase() {
    if (!firebase || !firebase.auth || !firebase.firestore) {
      alert('Firebase no carg√≥. Revisa firebase-config.js');
      throw new Error('Firebase missing');
    }
  }

  async function requireAdmin(user) {
    const doc = await firebase.firestore().collection('users').doc(user.uid).get();
    if (!doc.exists || !doc.data().isAdmin) {
      alert('Acceso solo para administradores');
      location.href = 'inicio.html';
      return false;
    }
    return true;
  }

  firebase.auth().onAuthStateChanged(async (user) => {
    try {
      requireFirebase();
      if (!user) { location.href = 'index.html'; return; }
      const ok = await requireAdmin(user);
      if (!ok) return;
      currentUser = user;
      await loadNews();
      toast('Panel listo ‚úÖ');
    } catch (e) {
      console.error('[admin-news] auth error:', e);
      alert('Error inicializando el panel. Revisa consola.');
    }
  });

  // -------- CRUD --------
  function getFormData() {
    const title = qs('fTitle').value.trim();
    const feedTitle = (qs('fFeedTitle')?.value || '').trim(); // ‚úÖ NUEVO

    const category = qs('fCategory').value.trim() || 'Gaming';
    const published = qs('fPublished').value === 'true';

    const headerImageUrl = qs('fHeaderImage').value.trim();
    const statusText = qs('fStatusText').value.trim();

    const coverImageUrl = qs('fCover').value.trim();
    const gallery = parseGallery(qs('fGallery').value);

    return { title, feedTitle, category, published, headerImageUrl, statusText, coverImageUrl, gallery };
  }

  function normalizeBlocksForSave(){
    const clean = [];
    blocks.forEach((b) => {
      const type = String(b?.type || '').trim();
      if (!type) return;

      if (type === 'p') {
        const text = String(b.text || '').trim();
        if (text) clean.push({ type:'p', text });
        return;
      }
      if (type === 'h2') {
        const text = String(b.text || '').trim();
        if (text) clean.push({ type:'h2', text });
        return;
      }
      if (type === 'highlight') {
        const text = String(b.text || '').trim();
        if (text) clean.push({ type:'highlight', text });
        return;
      }
      if (type === 'img') {
        const url = String(b.url || '').trim();
        if (!url) return;
        const caption = String(b.caption || '').trim();
        const out = { type:'img', url };
        if (caption) out.caption = caption;
        clean.push(out);
        return;
      }
    });
    return clean;
  }

  function fillForm(data) {
    qs('fTitle').value = data.title || '';
    qs('fFeedTitle').value = data.feedTitle || ''; // ‚úÖ NUEVO
    updateFeedCounter();

    qs('fCategory').value = data.category || 'Gaming';
    qs('fPublished').value = (data.published === true) ? 'true' : 'false';

    qs('fHeaderImage').value = data.headerImageUrl || '';
    qs('fStatusText').value = data.statusText || '';

    qs('fCover').value = data.coverImageUrl || data.imageUrl || '';
    qs('fGallery').value = Array.isArray(data.gallery) ? data.gallery.join('\n') : '';

    blocks = Array.isArray(data.blocks) ? JSON.parse(JSON.stringify(data.blocks)) : [];
    renderBlocks();

    setImgPreview('headerPreview', qs('fHeaderImage').value, 'Vista previa del header');
    setImgPreview('coverPreview', qs('fCover').value, 'Vista previa del cover');

    qs('btnDelete').style.display = selectedId ? 'block' : 'none';
    qs('modeBadge').textContent = selectedId ? 'Editar' : 'Crear';
  }

  function resetForm() {
    selectedId = null;
    blocks = [];
    fillForm({ category: 'Gaming', published: true });
  }

  async function saveNews() {
    try {
      const data = getFormData();
      const blocksToSave = normalizeBlocksForSave();

      if (!data.title) { toast('Pon un t√≠tulo'); return; }
      if (!data.coverImageUrl) { toast('Pon el cover del feed'); return; }
      if (!data.headerImageUrl) { toast('Pon la imagen principal del header'); return; }
      if (!blocksToSave.length) { toast('Agrega contenido (bloques)'); return; }

      // ‚úÖ aviso si se pas√≥ de 45 (no bloquea)
      if ((data.feedTitle || '').length > FEED_MAX) {
        toast('‚ö†Ô∏è El t√≠tulo del feed pasa de 45 caracteres (se recortar√° en el inicio).');
      }

      const now = firebase.firestore.FieldValue.serverTimestamp();
      const shouldSetDate = data.published === true;

      const payload = {
        title: data.title,
        feedTitle: data.feedTitle || '', // ‚úÖ NUEVO
        category: data.category,
        published: data.published,

        coverImageUrl: data.coverImageUrl,
        headerImageUrl: data.headerImageUrl,
        statusText: data.statusText,

        blocks: blocksToSave,
        gallery: data.gallery,

        updatedAt: now,
      };

      if (!selectedId) {
        payload.createdAt = now;
        if (shouldSetDate) payload.date = now;
        const ref = await firebase.firestore().collection('news').add(payload);
        selectedId = ref.id;
        qs('btnDelete').style.display = 'block';
        qs('modeBadge').textContent = 'Editar';
        toast('Guardado ‚úÖ');
      } else {
        if (shouldSetDate) payload.date = now;
        await firebase.firestore().collection('news').doc(selectedId).update(payload);
        toast('Actualizado ‚úÖ');
      }

      await loadNews();
    } catch (e) {
      console.error('[admin-news] save error:', e);
      alert('‚ùå No se pudo guardar: ' + (e.message || e));
    }
  }

  async function publishNow() {
    if (!selectedId) { toast('Selecciona una noticia'); return; }
    try {
      const now = firebase.firestore.FieldValue.serverTimestamp();
      await firebase.firestore().collection('news').doc(selectedId).update({
        published: true,
        date: now,
        updatedAt: now,
      });
      qs('fPublished').value = 'true';
      toast('Publicada ‚úÖ');
      await loadNews();
    } catch (e) {
      console.error('[admin-news] publish error:', e);
      alert('‚ùå No se pudo publicar: ' + (e.message || e));
    }
  }

  async function unpublish() {
    if (!selectedId) { toast('Selecciona una noticia'); return; }
    try {
      const now = firebase.firestore.FieldValue.serverTimestamp();
      await firebase.firestore().collection('news').doc(selectedId).update({
        published: false,
        updatedAt: now,
      });
      qs('fPublished').value = 'false';
      toast('Despublicada ‚úÖ');
      await loadNews();
    } catch (e) {
      console.error('[admin-news] unpublish error:', e);
      alert('‚ùå No se pudo despublicar: ' + (e.message || e));
    }
  }

  async function deleteNews() {
    if (!selectedId) return;
    if (!confirm('¬øEliminar esta noticia?')) return;
    try {
      await firebase.firestore().collection('news').doc(selectedId).delete();
      toast('Eliminada ‚úÖ');
      resetForm();
      await loadNews();
    } catch (e) {
      console.error('[admin-news] delete error:', e);
      alert('‚ùå No se pudo eliminar: ' + (e.message || e));
    }
  }

  // -------- List / Filters --------
  async function loadNews() {
    const list = qs('newsList');
    const empty = qs('emptyState');
    list.innerHTML = '';
    empty.style.display = 'none';

    try {
      const snap = await firebase.firestore()
        .collection('news')
        .orderBy('updatedAt', 'desc')
        .limit(50)
        .get();

      lastDocs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
      applyFilterAndRender();
    } catch (e) {
      console.error('[admin-news] load error:', e);
      alert('‚ùå No se pudo cargar la lista. Revisa consola.');
    }
  }

  function applyFilterAndRender() {
    const list = qs('newsList');
    const empty = qs('emptyState');

    const filtered = lastDocs.filter(({ data }) => {
      if (currentFilter === 'published') return data.published === true;
      if (currentFilter === 'drafts') return data.published !== true;
      if (currentFilter === 'gaming') return String(data.category || '').toLowerCase() === 'gaming';
      return true;
    });

    qs('countBadge').textContent = String(filtered.length);

    list.innerHTML = '';
    if (!filtered.length) {
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    filtered.forEach(({ id, data }) => {
      const title = data.title || 'Noticia';
      const displayTitle = data.feedTitle || title; // ‚úÖ muestra el corto si existe
      const cover = (data.coverImageUrl || data.imageUrl || '').trim();
      const published = data.published === true;

      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <div class="thumb">
          ${cover ? `<img src="${cover}" alt="" loading="lazy">` : ''}
        </div>
        <div class="meta">
          <strong>${escapeHtml(displayTitle)}</strong>
          <div class="small">
            ${published ? 'üü¢ Publicada' : 'üü° Borrador'} ‚Ä¢ ${data.category || '‚Äî'} ‚Ä¢ ${fmtDate(data.date || data.updatedAt || data.createdAt)}
          </div>
          <div class="item-actions">
            <button class="btn" data-action="edit" data-id="${id}">Editar</button>
            ${published
              ? `<button class="btn btn-warning" data-action="unpub" data-id="${id}">Despublicar</button>`
              : `<button class="btn btn-success" data-action="pub" data-id="${id}">Publicar</button>`
            }
            <button class="btn btn-danger" data-action="del" data-id="${id}">Eliminar</button>
            <button class="btn" data-action="open" data-id="${id}">Ver</button>
          </div>
        </div>
      `;
      list.appendChild(el);
    });
  }

  // Delegaci√≥n de clicks en la lista
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');
    const found = lastDocs.find(x => x.id === id);
    if (!found) return;

    if (action === 'edit') {
      selectedId = id;
      fillForm(found.data);
      toast('Editando...');
      return;
    }
    if (action === 'pub') {
      selectedId = id;
      await publishNow();
      return;
    }
    if (action === 'unpub') {
      selectedId = id;
      await unpublish();
      return;
    }
    if (action === 'del') {
      selectedId = id;
      await deleteNews();
      return;
    }
    if (action === 'open') {
      window.open(`news.html?id=${encodeURIComponent(id)}`, '_blank');
      return;
    }
  });

  // Filtros
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      currentFilter = chip.getAttribute('data-filter');
      applyFilterAndRender();
    });
  });

  // -------- Events --------
  qs('btnSave').addEventListener('click', saveNews);
  qs('btnNew').addEventListener('click', resetForm);
  qs('btnPublishNow').addEventListener('click', publishNow);
  qs('btnUnpublish').addEventListener('click', unpublish);
  qs('btnDelete').addEventListener('click', deleteNews);

  qs('fCover').addEventListener('input', (e) => setImgPreview('coverPreview', e.target.value, 'Vista previa del cover'));
  qs('fHeaderImage').addEventListener('input', (e) => setImgPreview('headerPreview', e.target.value, 'Vista previa del header'));

  qs('btnGoHome').addEventListener('click', () => location.href = 'inicio.html');
  qs('btnLogout').addEventListener('click', async () => {
    if (!confirm('¬øCerrar sesi√≥n?')) return;
    try {
      await firebase.auth().signOut();
      location.href = 'index.html';
    } catch {
      location.href = 'index.html';
    }
  });

  // Botones bloques
  qs('addP').addEventListener('click', () => addBlock('p'));
  qs('addH2').addEventListener('click', () => addBlock('h2'));
  qs('addImg').addEventListener('click', () => addBlock('img'));
  qs('addHi').addEventListener('click', () => addBlock('highlight'));
  qs('btnClearBlocks').addEventListener('click', () => {
    if (!blocks.length) return;
    if (!confirm('¬øEliminar todos los bloques?')) return;
    blocks = [];
    renderBlocks();
  });

  // Inicial
  window.addEventListener('load', () => {
    resetForm();
    renderBlocks();
    updateFeedCounter();
  });
</script>
</body>
</html>
