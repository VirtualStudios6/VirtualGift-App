<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#06011c" />
  <title>üõ† Panel de Noticias ¬∑ VirtualGift</title>

  <!-- Firebase (defer para no bloquear render) -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="js/firebase-config.js"></script>

  <!-- withAppFlag disponible antes de cualquier onclick -->
  <script>
    function withAppFlag(url) {
      const isAndroidApp =
        document.documentElement.classList.contains("android-app") ||
        document.body.classList.contains("android-app");
      if (!isAndroidApp) return url;
      if (url.includes("app=android")) return url;
      const parts = url.split("#");
      const base  = parts[0];
      const hash  = parts[1] ? "#" + parts[1] : "";
      const fixed = base.includes("?") ? base + "&app=android" : base + "?app=android";
      return fixed + hash;
    }
  </script>

  <style>
    :root {
      --bg1: #020515;
      --bg2: #06011c;
      --card: #1c1f2f;
      --text: #dcefff;
      --muted: #b6c6d9;
      --border: #293244;
      --primary: #8d17fb;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --shadow: 0 10px 35px rgba(0,0,0,.45);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; font-family: Inter, Roboto, Arial, sans-serif; }

    body {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
      padding: 18px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
      padding-left:  calc(18px + env(safe-area-inset-left));
      padding-right: calc(18px + env(safe-area-inset-right));
    }

    .wrap { max-width: 1100px; margin: 0 auto; }

    /* ---- Gate (cargando / acceso denegado) ---- */
    .gate {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 12px;
      text-align: center;
    }
    .gate-spinner {
      width: 42px; height: 42px;
      border: 3px solid rgba(41,50,68,.75);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin .9s linear infinite;
    }
    .gate-icon { font-size: 3em; }
    .gate-title { font-size: 1.1em; font-weight: 900; }
    .gate-sub   { font-size: .9em; color: var(--muted); }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---- Header ---- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; margin-bottom: 16px;
    }
    .title    { font-size: 22px; font-weight: 900; letter-spacing: .02em; }
    .subtitle { color: var(--muted); font-size: 13px; margin-top: 4px; }
    .top-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    /* ---- Botones ---- */
    .btn {
      border: 1px solid rgba(255,255,255,.08);
      cursor: pointer; border-radius: 12px;
      padding: 10px 14px; font-weight: 800;
      background: rgba(255,255,255,.06); color: var(--text);
      transition: .2s; font-family: Inter, Roboto, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active  { transform: scale(.985); }
    .btn:hover   { transform: translateY(-1px); box-shadow: var(--shadow); border-color: rgba(141,23,251,.45); }
    .btn:disabled { opacity: .55; pointer-events: none; }

    .btn-primary { background: linear-gradient(90deg, var(--primary), #70189b); border: none; color: #fff; }
    .btn-danger  { background: rgba(239,68,68,.12);  border: 1px solid rgba(239,68,68,.35);  color: #ffd5d5; }
    .btn-success { background: rgba(16,185,129,.12); border: 1px solid rgba(16,185,129,.35); color: #d9fff0; }
    .btn-warning { background: rgba(245,158,11,.12); border: 1px solid rgba(245,158,11,.35); color: #ffe9c2; }

    /* ---- Grid ---- */
    .grid {
      display: grid;
      grid-template-columns: 470px 1fr;
      gap: 14px; align-items: start;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    /* ---- Card ---- */
    .card {
      background: rgba(28,31,47,.9);
      border: 1px solid rgba(41,50,68,.7);
      border-radius: 18px; padding: 14px;
      box-shadow: 0 8px 28px rgba(0,0,0,.35);
    }
    .card h2 {
      font-size: 16px; font-weight: 900; margin-bottom: 10px;
      display: flex; align-items: center; gap: 10px;
    }
    .badge {
      font-size: 12px; padding: 4px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
    }

    /* ---- Form ---- */
    label { display: block; margin-top: 10px; font-size: 12px; color: var(--muted); }
    input, textarea, select {
      width: 100%; margin-top: 6px; padding: 10px 12px;
      border-radius: 12px; border: 1px solid rgba(255,255,255,.08);
      background: rgba(2,5,21,.35); color: var(--text);
      outline: none; font-family: Inter, Roboto, Arial, sans-serif;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: rgba(141,23,251,.55);
      box-shadow: 0 0 0 3px rgba(141,23,251,.10);
    }
    textarea { min-height: 110px; resize: vertical; line-height: 1.5; }
    select option { background: #1c1f2f; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 520px) { .row { grid-template-columns: 1fr; } }

    /* ---- Preview ---- */
    .preview {
      margin-top: 10px; border-radius: 14px; overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(2,5,21,.35);
      height: 180px; display: flex; align-items: center; justify-content: center;
      color: rgba(220,239,255,.7);
    }
    .preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .muted { color: var(--muted); font-size: 12px; }

    .feed-meta {
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px; margin-top: 6px; flex-wrap: wrap;
    }
    .counter {
      font-size: 12px; color: var(--muted);
      padding: 4px 10px; border-radius: 999px;
      background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.07);
    }
    .counter.warn {
      color: #ffd5d5; border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10);
    }

    /* ---- Filtros ---- */
    .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; align-items: center; }
    .filters .chip {
      padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);
      cursor: pointer; font-weight: 800; font-size: 12px; color: var(--text);
      -webkit-tap-highlight-color: transparent;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .chip.active { border-color: rgba(141,23,251,.6); box-shadow: 0 0 0 3px rgba(141,23,251,.12); }

    /* ---- Lista ---- */
    .list { display: grid; gap: 10px; }
    .item {
      display: grid; grid-template-columns: 92px 1fr; gap: 12px;
      padding: 10px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(2,5,21,.22);
      transition: border-color .2s ease;
    }
    .item:hover { border-color: rgba(141,23,251,.35); }
    .thumb {
      width: 92px; height: 92px; border-radius: 14px; overflow: hidden;
      border: 1px solid rgba(255,255,255,.08); background: rgba(28,31,47,.8);
    }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .meta { display: flex; flex-direction: column; gap: 6px; }
    .meta strong { font-size: 14px; line-height: 1.2; }
    .meta .small { font-size: 12px; color: var(--muted); line-height: 1.2; }
    .item-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
    .item-actions .btn { padding: 7px 10px; font-size: 12px; border-radius: 10px; }

    .sep { height: 1px; background: rgba(255,255,255,.06); margin: 10px 0; }

    /* ---- Toast ---- */
    .toast {
      position: fixed; left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(28,31,47,.95);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 16px; border-radius: 999px;
      color: var(--text); box-shadow: var(--shadow);
      display: none; z-index: 9999;
      max-width: 92vw; font-size: 14px; font-weight: 700;
    }

    /* ---- Bloques ---- */
    .block-tools { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .block-tools .btn { padding: 9px 12px; font-size: 12px; }
    .blocks { display: grid; gap: 10px; margin-top: 10px; }
    .block {
      border-radius: 16px; border: 1px solid rgba(255,255,255,.08);
      background: rgba(2,5,21,.22); overflow: hidden;
    }
    .block-head {
      display: flex; align-items: center; justify-content: space-between;
      gap: 10px; padding: 10px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .block-type {
      display: flex; align-items: center; gap: 8px;
      font-weight: 900; font-size: 12px; color: rgba(220,239,255,.92);
    }
    .block-mini {
      font-size: 11px; color: var(--muted);
      background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.07);
      padding: 3px 8px; border-radius: 999px;
    }
    .block-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .block-actions .btn { padding: 7px 10px; border-radius: 10px; font-size: 12px; }
    .block-body { padding: 10px; }
    .block-body textarea, .block-body input { margin-top: 0; }

    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.3; }

    .mini-preview {
      margin-top: 10px; border-radius: 14px; overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(2,5,21,.35);
      height: 140px; display: flex; align-items: center; justify-content: center;
      color: rgba(220,239,255,.7);
    }
    .mini-preview img { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* ---- Modal custom (reemplaza alert/confirm) ---- */
    .vg-modal-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: rgba(2,5,21,.82);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      display: none; align-items: center; justify-content: center;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
    .vg-modal-box {
      background: rgba(28,31,47,.98);
      border: 1px solid rgba(41,50,68,.75);
      border-radius: 22px; padding: 22px 18px 18px;
      width: 100%; max-width: 340px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      display: flex; flex-direction: column; gap: 16px;
      animation: modalIn .18s ease;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(.96) translateY(8px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }
    .vg-modal-msg {
      font-size: .97em; font-weight: 700; color: var(--text);
      line-height: 1.55; text-align: center; white-space: pre-line; margin: 0;
    }
    .vg-modal-actions { display: flex; gap: 10px; }
    .vg-modal-actions .btn { flex: 1; padding: 13px 10px; border-radius: 14px; }

    @media (max-width: 768px) {
      .top-actions { flex-wrap: wrap; }
      .top-actions .btn { flex: 1; min-width: 120px; text-align: center; }
    }
  </style>
</head>

<body>
<!-- ============================================ -->
<!-- GATE: CARGANDO -->
<!-- ============================================ -->
<div id="gateLoading" class="gate">
  <div class="gate-spinner"></div>
  <div class="gate-title">Verificando permisos...</div>
</div>

<!-- ============================================ -->
<!-- GATE: ACCESO DENEGADO -->
<!-- ============================================ -->
<div id="gateDenied" class="gate" style="display:none;">
  <div class="gate-icon">üö´</div>
  <div class="gate-title">Acceso restringido</div>
  <div class="gate-sub">Solo administradores pueden acceder a este panel.</div>
  <button class="btn" onclick="window.location.href=withAppFlag('inicio.html')" style="margin-top:10px;">
    ‚Üê Volver al inicio
  </button>
</div>

<!-- ============================================ -->
<!-- CONTENIDO ADMIN (solo visible si isAdmin)   -->
<!-- ============================================ -->
<div id="adminWrap" style="display:none;">
<div class="wrap">

  <header>
    <div>
      <div class="title">üõ† VirtualNews</div>
      <div class="subtitle">Gestiona las noticias del feed.</div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnGoHome">‚Üê Inicio</button>
      <button class="btn btn-danger" id="btnLogout">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="grid">

    <!-- ======================================== -->
    <!-- FORMULARIO / EDITOR                      -->
    <!-- ======================================== -->
    <section class="card">
      <h2>üìù Editor <span id="modeBadge" class="badge">Crear</span></h2>

      <label for="fTitle">T√≠tulo (dentro de la noticia)</label>
      <input id="fTitle" placeholder="El encabezado de la noticia." />

      <label for="fFeedTitle">T√≠tulo del feed (corto)</label>
      <input id="fFeedTitle" placeholder="T√≠tulo corto del feed." maxlength="45" />
      <div class="feed-meta">
        <span></span>
        <span id="feedCounter" class="counter">0/45</span>
      </div>

      <div class="row">
        <div>
          <label for="fCategory">Categor√≠a</label>
          <select id="fCategory">
            <option value="Gaming">Gaming</option>
            <option value="General">General</option>
          </select>
        </div>
        <div>
          <label for="fPublished">Estado</label>
          <select id="fPublished">
            <option value="true">Publicado</option>
            <option value="false">Borrador</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="fHeaderImage">Imagen del header (URL)</label>
          <input id="fHeaderImage" placeholder="https://..." />
        </div>
        <div>
          <label for="fStatusText">Status (opcional)</label>
          <input id="fStatusText" placeholder="Noticia Exclusiva" />
        </div>
      </div>

      <div id="headerPreview" class="mini-preview">
        <span class="muted">Vista previa del header</span>
      </div>

      <label for="fCover">Cover (URL) ‚Äî imagen del feed</label>
      <input id="fCover" placeholder="https://..." />

      <div id="coverPreview" class="preview">
        <span class="muted">Vista previa del cover</span>
      </div>

      <div class="sep"></div>

      <h2>üß© Contenido <span class="badge" id="blocksCount">0 bloques</span></h2>

      <div class="block-tools">
        <button class="btn" id="addP">+ P√°rrafo</button>
        <button class="btn" id="addH2">+ Subt√≠tulo</button>
        <button class="btn" id="addImg">+ Imagen</button>
        <button class="btn" id="addHi">+ Caja destacada</button>
        <button class="btn btn-warning" id="btnClearBlocks" disabled>Limpiar bloques</button>
      </div>

      <div id="blocks" class="blocks"></div>

      <p class="hint">Orden recomendado: <b>P√°rrafo</b> ‚Üí <b>Imagen</b> ‚Üí <b>P√°rrafo</b> ‚Üí <b>Caja destacada</b> ‚Üí <b>Subt√≠tulo</b> ‚Üí ...</p>

      <div class="sep"></div>

      <label for="fGallery">Galer√≠a (URLs separadas por coma o por l√≠nea) (opcional)</label>
      <textarea id="fGallery" placeholder="https://img1...&#10;https://img2..."></textarea>

      <div class="sep"></div>

      <div class="row">
        <button class="btn btn-primary" id="btnSave">üíæ Guardar</button>
        <button class="btn" id="btnNew">+ Nueva</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn btn-success" id="btnPublishNow">üöÄ Publicar ahora</button>
        <button class="btn btn-warning" id="btnUnpublish">üì¶ Despublicar</button>
      </div>

      <button class="btn btn-danger" id="btnDelete" style="margin-top:10px;display:none;">üóë Eliminar noticia</button>

      <p class="muted" style="margin-top:10px;">"Publicar ahora" actualiza <b>date</b> para que suba al inicio del feed.</p>
    </section>

    <!-- ======================================== -->
    <!-- LISTA DE NOTICIAS                        -->
    <!-- ======================================== -->
    <section class="card">
      <h2>üì∞ Noticias <span id="countBadge" class="badge">0</span></h2>

      <div class="filters">
        <div class="chip active" data-filter="all">Todas</div>
        <div class="chip" data-filter="published">Publicadas</div>
        <div class="chip" data-filter="drafts">Borradores</div>
      </div>

      <div id="newsList" class="list"></div>
      <p id="emptyState" class="muted" style="display:none; padding:10px;">No hay noticias todav√≠a.</p>
    </section>

  </div><!-- /grid -->
</div><!-- /wrap -->
</div><!-- /adminWrap -->

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- ============================================ -->
<!-- MODALES CUSTOM (reemplazan alert/confirm)    -->
<!-- ============================================ -->
<div id="vg-confirm-overlay" class="vg-modal-overlay" role="dialog" aria-modal="true">
  <div class="vg-modal-box">
    <p id="vg-confirm-msg" class="vg-modal-msg"></p>
    <div class="vg-modal-actions">
      <button id="vg-confirm-cancel" class="btn">Cancelar</button>
      <button id="vg-confirm-ok"     class="btn btn-primary">Confirmar</button>
    </div>
  </div>
</div>

<div id="vg-alert-overlay" class="vg-modal-overlay" role="dialog" aria-modal="true">
  <div class="vg-modal-box">
    <p id="vg-alert-msg" class="vg-modal-msg"></p>
    <div class="vg-modal-actions" style="justify-content:center;">
      <button id="vg-alert-ok" class="btn btn-primary" style="max-width:160px;">Entendido</button>
    </div>
  </div>
</div>

<script defer src="js/admin-news.js"></script>
</body>
</html>
